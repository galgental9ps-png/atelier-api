<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AR Atelier Schwarzenberger â€“ Auto-Liste (Quick Look & Scene Viewer)</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root { color-scheme: dark; }
    html,body { margin:0; height:100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; background:#000; color:#fff; }
    header { padding:16px; text-align:center; }
    main { max-width:1000px; margin:0 auto; padding:16px; }
    .row { display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width:900px){ .row { grid-template-columns: 1fr 1fr; } }
    .btn { display:inline-flex; align-items:center; gap:.5rem; background:#0ea5e9; color:#fff; padding:10px 14px; border-radius:12px; font-weight:700; text-decoration:none; }
    .note { opacity:.8; font-size:.95rem; }
    .card { background:#0a0a0a; border:1px solid #222; border-radius:14px; padding:14px; }
    .center { text-align:center; }
    .picker { display:flex; gap:8px; justify-content:center; align-items:center; margin:12px 0; flex-wrap:wrap; }
    select { background:#121212; color:#fff; border:1px solid #333; border-radius:10px; padding:8px 10px; }
    .ar-poster { width:1px; height:1px; opacity:0; pointer-events:none; } /* iOS Quick Look braucht <img> im <a rel="ar"> */
    .warn { color:#fbbf24; }
    .error { color:#f87171; }
    .disabled { opacity:.5; pointer-events:none; }
  </style>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <header>
    <h1>AR Poster</h1>
    <p class="note">Motive werden automatisch aus deinem Repo geladen. iOS: Quick Look (USDZ). Android: Scene Viewer (GLB).</p>
  </header>

  <main>
    <section class="card">
      <h2 class="center">Motiv wÃ¤hlen</h2>
      <div class="picker">
        <label for="assetSelect">Motiv:</label>
        <select id="assetSelect" aria-label="AR-Motiv wÃ¤hlen">
          <option disabled selected>Lade Motiveâ€¦</option>
        </select>
      </div>
      <p id="status" class="note center"></p>
    </section>

    <div class="row">
      <section class="card center">
        <h2>iOS (Quick Look)</h2>
        <!-- WICHTIG: <a rel="ar"> braucht ein <img>-Kind, sonst startet iOS teils nicht -->
        <a id="iosArLink" class="btn disabled" rel="ar" href="#">
          ðŸ“± In AR ansehen (iOS)
          <img class="ar-poster" alt=""
               src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAoMBg6E9yjcAAAAASUVORK5CYII=" />
        </a>
        <p class="note">Ã–ffne die Seite in Safari. Tippe den Button â€“ Quick Look startet.</p>
      </section>

      <section class="card center">
        <h2>Android (Scene Viewer)</h2>
        <a id="androidArLink" class="btn disabled" href="#" target="_blank" rel="noopener">
          ðŸ¤– In AR ansehen (Android)
        </a>
        <p class="note">Ã–ffne die Seite in Chrome. Tippe den Button â€“ Scene Viewer startet.</p>
      </section>
    </div>

    <section class="card">
      <h2>Vorschau im Browser (optional)</h2>
      <model-viewer
        id="mv"
        ar
        ar-modes="scene-viewer quick-look webxr"
        ar-scale="fixed"
        camera-controls
        exposure="1.0"
        shadow-intensity="0"
        style="width:100%; height:70vh; background:#000; border-radius:14px; border:1px solid #222;">
      </model-viewer>
      <p class="note">Das ist die 3D-Vorschau. FÃ¼r zuverlÃ¤ssige AR nutze die Buttons oben.</p>
    </section>
  </main>

  <script>
    // ====== KONFIG (dein Repo) ======
    const OWNER  = "galgental9ps-png";
    const REPO   = "atelier-api";
    const PATH   = "";       // Root. Falls Unterordner, z.B. "ar/"
    const BRANCH = "main";

    // GitHub API & RAW-Basis
    const API = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${BRANCH}`;
    const RAW = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${PATH}`;

    const select = document.getElementById('assetSelect');
    const status = document.getElementById('status');
    const iosArLink = document.getElementById('iosArLink');
    const androidArLink = document.getElementById('androidArLink');
    const mv = document.getElementById('mv');

    const isUSDZ = n => /\.usdz$/i.test(n);
    const isGLB  = n => /\.glb$/i.test(n);
    const stem   = n => n.replace(/\.(usdz|glb|gltf)$/i, "");

    function buildAndroidIntent(glbUrl, title) {
      const u = new URL("https://arvr.google.com/scene-viewer/1.0");
      u.searchParams.set("file", glbUrl);
      u.searchParams.set("mode", "ar_preferred");
      u.searchParams.set("title", title || "AR Poster");
      return u.toString();
    }

    function groupAssets(files) {
      const usdz = new Map(), glb = new Map();
      for (const f of files) {
        if (f.type !== "file") continue;
        if (isUSDZ(f.name)) usdz.set(stem(f.name), f.name);
        if (isGLB(f.name))  glb.set(stem(f.name),  f.name);
      }
      const all = new Set([...usdz.keys(), ...glb.keys()]);
      const list = [...all].map(s => ({ name: s, usdz: usdz.get(s) || null, glb: glb.get(s) || null }))
                           .sort((a,b) => a.name.localeCompare(b.name, 'de'));
      return list;
    }

    function populateSelect(pairs) {
      select.innerHTML = "";
      let first = null;
      for (const p of pairs) {
        if (!p.usdz && !p.glb) continue;
        const opt = document.createElement("option");
        opt.value = p.name;
        opt.textContent = p.name + (!p.usdz || !p.glb ? ` ${!p.usdz ? "(ohne USDZ)" : ""}${!p.glb ? "(ohne GLB)" : ""}` : "");
        select.appendChild(opt);
        if (!first) first = p.name;
      }
      if (!first) throw new Error("Keine passenden Dateien gefunden (.usdz/.glb).");
      return first;
    }

    function updateAsset(name, pairs) {
      const p = pairs.find(x => x.name === name);
      if (!p) return;

      const usdzUrl = p.usdz ? `${RAW}${p.usdz}` : null;
      const glbUrl  = p.glb  ? `${RAW}${p.glb}`  : null;

      // iOS
      if (usdzUrl) { iosArLink.href = usdzUrl; iosArLink.classList.remove("disabled"); }
      else         { iosArLink.href = "#";      iosArLink.classList.add("disabled");  }

      // Android
      if (glbUrl)  { androidArLink.href = buildAndroidIntent(glbUrl, name); androidArLink.classList.remove("disabled"); }
      else         { androidArLink.href = "#";                                 androidArLink.classList.add("disabled");  }

      // Vorschau
      if (usdzUrl) mv.setAttribute("ios-src", usdzUrl); else mv.removeAttribute("ios-src");
      if (glbUrl)  mv.setAttribute("src", glbUrl);      else mv.removeAttribute("src");

      // Hinweis
      if (!p.usdz || !p.glb) {
        status.innerHTML = `<span class="warn">Hinweis:</span> FÃ¼r â€ž${name}â€œ ${
          !p.usdz && !p.glb ? "fehlen USDZ <u>und</u> GLB" :
          !p.usdz ? "fehlt USDZ (iOS Quick Look)" : "fehlt GLB (Android Scene Viewer)"
        }.`;
      } else {
        status.textContent = "";
      }
    }

    async function init() {
      status.textContent = "Lade Dateien aus GitHubâ€¦";
      try {
        const res = await fetch(API, { headers: { "Accept": "application/vnd.github+json" }});
        if (!res.ok) throw new Error(`GitHub API Fehler: ${res.status}`);
        const files = await res.json();

        // Gruppieren
        const pairs = groupAssets(files);

        // Fallback: wenn API blockiert, min. circling_flow manuell anbieten
        if (!Array.isArray(files) || !files.length) {
          console.warn("GitHub API leer/blocked â€“ Fallback aktiv.");
          const fallback = [{ name: "circling_flow", usdz: "circling_flow.usdz", glb: "circling_flow.glb" }];
          populateSelect(fallback);
          updateAsset("circling_flow", fallback);
          status.innerHTML = `<span class="warn">Hinweis:</span> Fallback aktiv â€“ nur â€žcircling_flowâ€œ sichtbar.`;
          return;
        }

        // Dropdown fÃ¼llen
        const first = populateSelect(pairs);

        // Vorauswahl rendern
        updateAsset(first, pairs);

        // Wechsel
        select.addEventListener("change", e => updateAsset(e.target.value, pairs));

        status.textContent = "";
      } catch (err) {
        console.error(err);
        // Harte Fallback-Route mit circling_flow (deine Datei existiert sicher)
        const fallback = [{ name: "circling_flow", usdz: "circling_flow.usdz", glb: "circling_flow.glb" }];
        select.innerHTML = `<option value="circling_flow">circling_flow</option>`;
        updateAsset("circling_flow", fallback);
        status.innerHTML = `<span class="error">Fehler:</span> ${String(err.message || err)} â€“ Fallback nur â€žcircling_flowâ€œ.`;
      }
    }

    init();
  </script>
</body>
</html>
