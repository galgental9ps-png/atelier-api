<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>AR Hit-Test (WebXR) – Bild an Wand platzieren</title>
<style>
  :root { color-scheme: dark; }
  html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  #ui { position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:20; display:flex; gap:8px; }
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;font-weight:700;color:#fff;background:#0ea5e9}
  .btn.alt{background:#111a;border:1px solid #333}
  #status{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:20;background:#000b;border:1px solid #333;padding:10px 12px;border-radius:10px}
  canvas{display:block}
  /* Fallback (AR-Lite) */
  #fallback{position:fixed;inset:0;display:none}
  #fbVideo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  #art{position:absolute;top:50%;left:50%;width:40vmin;aspect-ratio:4/3;transform:translate(-50%,-50%);pointer-events:auto;touch-action:none}
  #art img{width:100%;height:100%;display:block;border-radius:8px;box-shadow:0 8px 24px #0009}
  #panel{position:fixed;right:10px;top:60px;background:#000c;border:1px solid #333;border-radius:12px;padding:10px;z-index:20;display:none}
  #panel input[type="range"]{width:200px}
</style>
</head>
<body>
<div id="ui">
  <button id="btnStart" class="btn">AR starten</button>
  <button id="btnReset" class="btn alt" title="Reticle neu suchen">Neu zielen</button>
</div>
<div id="status">Bereit…</div>

<!-- Fallback UI -->
<div id="fallback">
  <video id="fbVideo" autoplay playsinline muted></video>
  <div id="panel">
    <div style="color:#fff;margin-bottom:8px">Fallback: Tippe zum Platzieren</div>
    Größe <input id="fbSize" type="range" min="10" max="250" value="40"><br>
    Drehung <input id="fbRot" type="range" min="-180" max="180" value="0"><br>
    Deckkraft <input id="fbAlpha" type="range" min="20" max="100" value="100">
  </div>
  <div id="art"><img id="artImg" alt=""></div>
</div>

<script type="module">
/* ========= PARAMS ========= */
const qs = new URLSearchParams(location.search);
const IMG_URL = qs.get('img') || 'https://galgental9ps-png.github.io/atelier-api/echo_der_gedanken.jpg';

/* ========= DOM ========= */
const statusEl = document.getElementById('status');
const btnStart = document.getElementById('btnStart');
const btnReset = document.getElementById('btnReset');
btnReset.disabled = true;

/* ========= FEATURE DETECT ========= */
const hasWebXR = !!(navigator.xr && navigator.xr.isSessionSupported);

/* ========= THREE + AR ========= */
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.159/build/three.module.js';
import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.159/examples/jsm/webxr/ARButton.js';

let renderer, scene, camera, xrRefSpace, hitTestSource, hitSourceRequested=false;
let reticle, placedMesh, texture;

async function loadTexture(url){
  return new Promise((resolve,reject)=>{
    new THREE.TextureLoader().setCrossOrigin('anonymous').load(url, tex=>{
      tex.colorSpace = THREE.SRGBColorSpace;
      resolve(tex);
    }, undefined, err=>reject(err));
  });
}

function makeReticle(){
  const geo = new THREE.RingGeometry(0.06,0.08,48).rotateX(-Math.PI/2);
  const mat = new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent:true, opacity:0.85 });
  const m = new THREE.Mesh(geo, mat);
  m.matrixAutoUpdate = false;
  m.visible = false;
  return m;
}

function makeArtworkPlane(tex){
  const aspect = tex.image.width/tex.image.height || 4/3;
  const height = 0.8; // 80 cm standard
  const width = height*aspect;
  const geo = new THREE.PlaneGeometry(width, height);
  const mat = new THREE.MeshBasicMaterial({ map: tex, transparent:false });
  const mesh = new THREE.Mesh(geo, mat);
  return mesh;
}

async function startXR(){
  if (!await navigator.xr.isSessionSupported('immersive-ar')){
    // Fallback
    startFallback();
    return;
  }

  statusEl.textContent = 'Starte AR…';
  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setPixelRatio(devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera();
  scene.add(new THREE.AmbientLight(0xffffff, 1.0));

  reticle = makeReticle();
  scene.add(reticle);

  texture = await loadTexture(IMG_URL).catch(()=>null);
  if(!texture){ statusEl.textContent='Bild konnte nicht geladen werden (CORS/URL)'; }

  const session = await navigator.xr.requestSession('immersive-ar', {
    requiredFeatures: ['hit-test', 'local'],
    optionalFeatures: ['dom-overlay'],
    domOverlay: { root: document.body }
  });
  renderer.xr.setReferenceSpaceType('local');
  await renderer.xr.setSession(session);

  session.addEventListener('select', () => {
    if (reticle?.visible && texture) {
      // Bild-Plane an Hit-Position verankern
      if (placedMesh) scene.remove(placedMesh);
      placedMesh = makeArtworkPlane(texture);
      placedMesh.position.setFromMatrixPosition(reticle.matrix);
      // leicht von der Fläche abheben, damit es nicht "flackert"
      placedMesh.translateZ(0.005);
      // zur Kamera ausrichten, aber „an Wand“ bleiben:
      const cam = renderer.xr.getCamera(camera);
      placedMesh.lookAt(cam.position);
      placedMesh.rotateX(0); // Wandparallel
      scene.add(placedMesh);
      statusEl.textContent = 'Platziert ✔︎ (Tippe erneut, um neu zu setzen)';
    }
  });

  btnReset.disabled = false;
  btnReset.onclick = ()=>{ hitSourceRequested=false; statusEl.textContent='Ziele auf Wand/Boden…'; };

  renderer.setAnimationLoop(onXRFrame);
  statusEl.textContent = 'Ziele auf Wand/Boden und tippe zum Platzieren';
}

async function onXRFrame(timestamp, frame){
  const session = renderer.xr.getSession();
  const refSpace = renderer.xr.getReferenceSpace();

  if (!hitSourceRequested){
    const viewerSpace = await session.requestReferenceSpace('viewer');
    const src = await session.requestHitTestSource({ space: viewerSpace });
    hitTestSource = src;
    xrRefSpace = refSpace;
    hitSourceRequested = true;
  }

  const pose = frame.getViewerPose(refSpace);
  if (pose && hitTestSource){
    const hits = frame.getHitTestResults(hitTestSource);
    if (hits.length){
      const hit = hits[0];
      const hitPose = hit.getPose(xrRefSpace);
      reticle.visible = true;
      reticle.matrix.fromArray(hitPose.transform.matrix);
      statusEl.textContent = 'Tippe, um zu platzieren';
    }else{
      reticle.visible = false;
      statusEl.textContent = 'Ziele auf strukturierte Fläche…';
    }
  }

  renderer.render(scene, camera);
}

/* ========= Fallback (AR-Lite) ========= */
async function startFallback(){
  statusEl.textContent = 'Kein WebXR → Fallback aktiv';
  document.getElementById('fallback').style.display='block';
  document.getElementById('panel').style.display='block';
  const video = document.getElementById('fbVideo');
  try{
    const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'} }, audio:false });
    video.srcObject = s;
  }catch(e){
    statusEl.textContent = 'Kamera-Fehler: '+e.message;
  }
  const art = document.getElementById('art'), img = document.getElementById('artImg');
  // Bild laden
  fetch(IMG_URL, {mode:'cors'}).then(r=>r.blob()).then(b=>{
    const u = URL.createObjectURL(b);
    img.onload = ()=>URL.revokeObjectURL(u);
    img.src = u;
  }).catch(()=> statusEl.textContent='Bild konnte nicht geladen werden');

  // Tippen = versetzen
  document.getElementById('fallback').addEventListener('pointerdown', e=>{
    const x = e.clientX/window.innerWidth*100;
    const y = e.clientY/window.innerHeight*100;
    art.style.left = x+'%'; art.style.top = y+'%';
    art.style.transform = 'translate(-50%,-50%) rotate('+document.getElementById('fbRot').value+'deg)';
  });
  // Regler
  const size = document.getElementById('fbSize');
  const rot  = document.getElementById('fbRot');
  const alp  = document.getElementById('fbAlpha');
  size.oninput = ()=>{ art.style.width = size.value+'vmin'; };
  rot.oninput  = ()=>{ art.style.transform = 'translate(-50%,-50%) rotate('+rot.value+'deg)'; };
  alp.oninput  = ()=>{ art.style.opacity = (alp.value/100).toString(); };
}

/* ========= Boot ========= */
btnStart.onclick = async ()=>{
  if (hasWebXR){
    try{
      await startXR();
      // Replace default ARButton prompt with our own button disabled
      btnStart.disabled = true; btnStart.textContent = 'AR läuft';
    }catch(e){
      console.warn(e);
      startFallback();
    }
  }else{
    startFallback();
  }
};

// optional: Auto-Start wenn erlaubt (muss per Nutzerinteraktion erfolgen, daher Button)
</script>
</body>
</html>
