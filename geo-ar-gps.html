<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Geo-AR â€“ WÃ¼rfel & Bild mit Firebase</title>

<!-- A-Frame + AR.js -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
<script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAd4_0zLdbI6jkjcZZUtMSWCYKP14dGHzQ",
    authDomain: "geo-ar-2c66d.firebaseapp.com",
    projectId: "geo-ar-2c66d",
    storageBucket: "geo-ar-2c66d.appspot.com",
    messagingSenderId: "232770478087",
    appId: "1:232770478087:web:d0d6cb8a585bdef5fdcaa2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window._db = db;
  window._fs = { collection, addDoc, getDocs, serverTimestamp };
</script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif}
  #overlay{position:fixed;inset:0;display:grid;place-items:center;background:#000c;z-index:10;text-align:center;padding:16px}
  .btn{padding:12px 14px;border:0;border-radius:12px;font-weight:800;color:#fff;background:#0ea5e9;margin:0 6px;cursor:pointer}
  #status{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);
    background:#000d;padding:10px 14px;border-radius:10px;z-index:5;white-space:nowrap;font-weight:700}
  #hud{position:fixed;top:84px;left:50%;transform:translateX(-50%);
    z-index:6;display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none}
  #arrow{width:96px;height:96px;filter:drop-shadow(0 0 8px #00ffff);transition:transform 80ms linear}
  #dist{font-size:18px;font-weight:900;background:#000c;padding:8px 12px;border-radius:999px}
  #corner{position:fixed;top:12px;right:12px;z-index:7;display:flex;gap:8px;align-items:center}
  .chip{background:#000d;border:1px solid #1f2937;color:#fff;padding:8px 10px;border-radius:10px;font-size:12px}
</style>
</head>
<body>

<div id="overlay">
  <div>
    <h1 style="margin:0 0 8px">Geo-AR starten</h1>
    <p style="opacity:.9;max-width:640px;margin:0 auto 14px">
      Erlaube <b>Kamera</b> & <b>Standort</b>.<br>
      â€žLos gehtâ€™sâ€œ zeigt Spots mit WÃ¼rfel + Bild + HUD.<br>
      â€žSpot setzenâ€œ speichert neuen Spot (PW: <code>1234</code>).
    </p>
    <button id="start" class="btn">Los gehtâ€™s</button>
    <button id="admin" class="btn" style="background:#ef4444">Spot setzen</button>
  </div>
</div>

<div id="corner">
  <div class="chip">ðŸŽ¯ NÃ¤chster Spot: <span id="nearestName">â€“</span></div>
</div>

<div id="hud">
  <svg id="arrow" viewBox="0 0 100 100">
    <polygon points="50,5 80,55 60,55 60,95 40,95 40,55 20,55" fill="#00ffff" opacity="0.95"/>
  </svg>
  <div id="dist">Entfernung: â€“</div>
</div>

<div id="status">Bereitâ€¦</div>
<div id="mount"></div>

<script type="module">
/*** Firebase handles ***/
const { collection, addDoc, getDocs, serverTimestamp } = window._fs;
const db = window._db;

/*** UI ***/
const mount = document.getElementById('mount');
const overlay = document.getElementById('overlay');
const statusEl = document.getElementById('status');
const arrowEl = document.getElementById('arrow');
const distEl = document.getElementById('dist');
const nearestNameEl = document.getElementById('nearestName');

/*** Settings ***/
const IMG_SRC = "https://galgental9ps-png.github.io/atelier-api/echo_der_gedanken.jpg";

/* Feste Spots */
const BASE_TARGETS = [
  { name: 'Altstadt', lat: 48.366184, lon: 10.867701 },
  { name: 'StettenstraÃŸe 7', lat: 48.368905, lon: 10.898445 }
];
let REMOTE_TARGETS = [];

/*** State ***/
let sceneEl, started=false, deviceHeadingDeg=null, geoWatchId=null;

/*** Buttons ***/
document.getElementById('start').addEventListener('click', startViewer);
document.getElementById('admin').addEventListener('click', startAdmin);

/*** Start Viewer ***/
async function startViewer(){
  try{
    await ensureCameraAndMotion();
    ensureScene();
    overlay.style.display='none';
    await ensureGeoWatch();

    BASE_TARGETS.forEach(t=>appendSpotEntity(t));
    await loadRemoteSpots();
    REMOTE_TARGETS.forEach(t=>appendSpotEntity(t));

    started=true;
    statusEl.textContent='Viewer aktiv.';
  }catch(e){ statusEl.textContent='Fehler: '+e.message; }
}

/*** Start Admin ***/
async function startAdmin(){
  const pw=prompt('Passwort:');
  if(pw!=='1234'){ alert('Falsch!'); return; }

  try{
    await ensureCameraAndMotion();
    ensureScene();
    overlay.style.display='none';
    const pos=await getOnceLocation();
    const { latitude, longitude, accuracy }=pos.coords;

    await addDoc(collection(db,'spots'),{
      name:'Echo der Gedanken',
      img:IMG_SRC,
      lat:Number(latitude.toFixed(6)),
      lon:Number(longitude.toFixed(6)),
      createdAt:serverTimestamp()
    });

    appendSpotEntity({name:'Echo der Gedanken', img:IMG_SRC, lat:latitude, lon:longitude});
    statusEl.textContent=`Gespeichert: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (Â±${Math.round(accuracy)} m)`;
  }catch(e){ statusEl.textContent='Admin-Fehler: '+e.message; }
}

/*** Szene ***/
function ensureScene(){
  if(sceneEl) return;
  mount.innerHTML=`
    <a-scene embedded vr-mode-ui="enabled:false"
      renderer="antialias:true; alpha:true"
      arjs="sourceType: webcam; videoTexture:true; trackingMethod: best; facingMode: environment;">
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>`;
  sceneEl=document.querySelector('a-scene');
  startHeadingListeners();
}

/*** Spot Entity (WÃ¼rfel + Bild + SÃ¤ule) ***/
function appendSpotEntity(d){
  const el=document.createElement('a-entity');
  el.setAttribute('gps-entity-place',`latitude:${d.lat}; longitude:${d.lon}`);

  // WÃ¼rfel
  const cube=document.createElement('a-box');
  cube.setAttribute('width','12'); cube.setAttribute('height','12'); cube.setAttribute('depth','12');
  cube.setAttribute('position','0 6 0');
  cube.setAttribute('material','color:#00ffff; opacity:0.95; shader:flat; side:double');
  cube.setAttribute('animation','property: rotation; to:0 360 0; loop:true; dur:9000; easing:linear');

  // LeuchtsÃ¤ule
  const beam=document.createElement('a-cylinder');
  beam.setAttribute('radius','1');
  beam.setAttribute('height','24');
  beam.setAttribute('position','0 12 0');
  beam.setAttribute('material','color:#00ffff; opacity:0.28; transparent:true; side:double');

  // Bild
  const img=document.createElement('a-image');
  img.setAttribute('src',d.img||IMG_SRC);
  img.setAttribute('scale','34 25.5 1');
  img.setAttribute('position','0 15 0');
  img.setAttribute('look-at','[gps-camera]');
  img.setAttribute('material','shader:flat; opacity:1; side:double');

  // Bodenring
  const ring=document.createElement('a-ring');
  ring.setAttribute('radius-inner','3.2');
  ring.setAttribute('radius-outer','3.8');
  ring.setAttribute('position','0 0 0.02');
  ring.setAttribute('material','color:#00ffff; opacity:0.95; shader:flat; side:double');

  el.appendChild(cube);
  el.appendChild(beam);
  el.appendChild(img);
  el.appendChild(ring);

  sceneEl.appendChild(el);
}

/*** Firestore laden ***/
async function loadRemoteSpots(){
  const snap=await getDocs(collection(db,'spots'));
  REMOTE_TARGETS=snap.docs.map(d=>({name:d.data().name,img:d.data().img,lat:d.data().lat,lon:d.data().lon}));
}

/*** Camera + Sensor ***/
async function ensureCameraAndMotion(){
  await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
  try{
    if(typeof DeviceMotionEvent?.requestPermission==='function'){ await DeviceMotionEvent.requestPermission().catch(()=>{});}
    if(typeof DeviceOrientationEvent?.requestPermission==='function'){ await DeviceOrientationEvent.requestPermission().catch(()=>{});}
  }catch(e){}
}

/*** GPS ***/
function getOnceLocation(){
  return new Promise((res,rej)=>{
    navigator.geolocation.getCurrentPosition(res,e=>rej(new Error(e.message)),{enableHighAccuracy:true,timeout:15000,maximumAge:0});
  });
}
function ensureGeoWatch(){
  return new Promise((resolve,reject)=>{
    navigator.geolocation.getCurrentPosition(p=>{
      if(geoWatchId!=null) navigator.geolocation.clearWatch(geoWatchId);
      geoWatchId=navigator.geolocation.watchPosition(
        pos=>updateHud(pos.coords),
        err=>statusEl.textContent='GPS-Fehler: '+err.message,
        {enableHighAccuracy:true,timeout:20000,maximumAge:0});
      updateHud(p.coords); resolve();
    },err=>reject(err),{enableHighAccuracy:true,timeout:15000,maximumAge:0});
  });
}

/*** HUD ***/
function updateHud(coords){
  const all=[...BASE_TARGETS,...REMOTE_TARGETS];
  if(!all.length) return;
  const {latitude,longitude,accuracy}=coords;
  const nearest=all.map(t=>({t,d:distM(latitude,longitude,t.lat,t.lon),brg:bearing(latitude,longitude,t.lat,t.lon)}))
                   .sort((a,b)=>a.d-b.d)[0];
  nearestNameEl.textContent=nearest.t.name;
  const txt=nearest.d>=1000?(nearest.d/1000).toFixed(2)+' km':Math.round(nearest.d)+' m';
  distEl.textContent=`Entfernung: ${txt} Â· GPS Â±${Math.round(accuracy)} m`;
  if(deviceHeadingDeg!=null){ const turn=((nearest.brg-deviceHeadingDeg)+360)%360; arrowEl.style.transform=`rotate(${turn}deg)`; }
}

/*** Kompass ***/
function startHeadingListeners(){
  window.addEventListener('deviceorientation',e=>{
    if(typeof e.webkitCompassHeading==='number'){deviceHeadingDeg=e.webkitCompassHeading;}
    else if(e.absolute===true&&typeof e.alpha==='number'){deviceHeadingDeg=360-e.alpha;}
  },true);
}
const toRad=d=>d*Math.PI/180,toDeg=r=>r*180/Math.PI;
function distM(la1,lo1,la2,lo2){const R=6371e3,dLa=toRad(la2-la1),dLo=toRad(lo2-lo1);const a=Math.sin(dLa/2)**2+Math.cos(toRad(la1))*Math.cos(toRad(la2))*Math.sin(dLo/2)**2;return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
function bearing(la1,lo1,la2,lo2){const Ï†1=toRad(la1),Ï†2=toRad(la2),Î»1=toRad(lo1),Î»2=toRad(lo2);const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2);const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1);return(toDeg(Math.atan2(y,x))+360)%360;}
</script>
</body>
</html>
