<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Geo-AR â€“ Echo der Gedanken (Ultra sichtbar + Distanz & Pfeil)</title>

<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;
    font-family:-apple-system,system-ui,Segoe UI,Inter,Roboto,sans-serif}
  #overlay{position:fixed;inset:0;display:grid;place-items:center;
    background:linear-gradient(#000c,#000c);z-index:10;text-align:center;padding:16px}
  .btn{padding:12px 14px;border:0;border-radius:12px;font-weight:800;color:#fff;background:#0ea5e9;margin:0 6px}
  #status{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);
    background:#000d;padding:10px 14px;border-radius:10px;z-index:5;white-space:nowrap;font-weight:700}
  /* HUD: groÃŸer Pfeil + Entfernung */
  #hud{position:fixed;top:12px;left:50%;transform:translateX(-50%);
    z-index:6;display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none}
  #arrow{width:96px;height:96px;filter:drop-shadow(0 0 8px #00ffff);transition:transform 80ms linear}
  #dist{font-size:18px;font-weight:900;background:#000c;padding:8px 12px;border-radius:999px}
  /* Testhinweis oben rechts */
  #corner{position:fixed;top:12px;right:12px;z-index:7;display:flex;gap:8px}
  .chip{background:#000d;border:1px solid #1f2937;color:#fff;padding:8px 10px;border-radius:10px;font-size:12px}
</style>
</head>
<body>

<div id="overlay">
  <div>
    <h1 style="margin:0 0 8px">Geo-AR starten</h1>
    <p style="opacity:.9;max-width:600px;margin:0 auto 14px">
      Erlaube <b>Kamera</b>. Bei iOS: <b>Bewegungssensor</b> zustimmen. FÃ¼r Geo-Spots zusÃ¤tzlich <b>Standort</b> erlauben.<br>
      <b>Tipp:</b> â€žHier testenâ€œ zeigt sofort einen <u>sehr auffÃ¤lligen Beacon</u> 1&nbsp;m vor dir.
    </p>
    <button id="start" class="btn">Los gehtâ€™s (Geo-Spots)</button>
    <button id="spawnHere" class="btn" style="background:#10b981">Hier testen (1 m vor dir)</button>
    <div style="font-size:13px;opacity:.8;margin-top:10px">DrauÃŸen testen & Kompass kalibrieren (âˆž-Bewegung).</div>
  </div>
</div>

<div id="corner"><div class="chip">ðŸŽ¯ NÃ¤chster Spot: <span id="nearestName">â€“</span></div></div>
<div id="hud">
  <!-- SVG-Pfeil (wird per CSS rotiert) -->
  <svg id="arrow" viewBox="0 0 100 100">
    <polygon points="50,5 80,55 60,55 60,95 40,95 40,55 20,55"
      fill="#00ffff" opacity="0.95"/>
  </svg>
  <div id="dist">Entfernung: â€“</div>
</div>

<div id="status">Bereitâ€¦</div>
<div id="mount"></div>

<script>
/*** Konfiguration ***/
const IMG_SRC = 'https://galgental9ps-png.github.io/atelier-api/echo_der_gedanken.jpg';
const TARGETS = [
  { name: 'Altstadt-Spot',   lat: 48.366184, lon: 10.867701 },
  { name: 'StettenstraÃŸe 7', lat: 48.368905, lon: 10.898445 } // 86150 Augsburg
];
const BIG_SCALE = '34 25.5 1';  // riesig & auffÃ¤llig
const TEST_SCALE = '12 9 1';    // sehr groÃŸ in 1 m

/*** Elemente ***/
const statusEl  = document.getElementById('status');
const mount     = document.getElementById('mount');
const overlay   = document.getElementById('overlay');
const arrowEl   = document.getElementById('arrow');
const distEl    = document.getElementById('dist');
const nearestNameEl = document.getElementById('nearestName');

let sceneEl, localImgEl, started = false;
let deviceHeadingDeg = null; // 0..360 (0=N)
let lastPos = null;

/*** Buttons ***/
document.getElementById('start').addEventListener('click', initGeo);
document.getElementById('spawnHere').addEventListener('click', spawnHere);

/*** Start mit Geo-Spots ***/
async function initGeo(){
  try{
    await ensureCameraAndMotion();
    await getOnceLocation(); // Standort notwendig fÃ¼r Distanzen
    buildScene();            // baut AR-Szene + Geo-Bilder
    overlay.style.display = 'none';
    started = true;
    watchDistanceAndHeading(); // HUD steuern
  }catch(err){
    statusEl.textContent = 'Fehler: ' + err.message;
  }
}

/*** Nur Test-Beacon (ohne Standort) â€“ startet Kamera automatisch ***/
async function spawnHere(){
  try{
    if(!started){
      await ensureCameraAndMotion(); // nur Kamera/Sensor
      buildScene();                  // Szene ohne Standort reicht
      overlay.style.display = 'none';
      started = true;
    }
    if(localImgEl){ localImgEl.remove(); }

    // Beacon: sehr auffÃ¤llig â€“ mit Glow-Hintergrund + pulsierendem Rahmen
    localImgEl = document.createElement('a-entity');

    const bg = document.createElement('a-plane'); // leuchtender Hintergrund
    bg.setAttribute('width','14');
    bg.setAttribute('height','10.5');
    bg.setAttribute('material','shader: flat; color: #00ffff; opacity: 0.18; transparent: true');
    bg.setAttribute('position','0 0 0');

    const img = document.createElement('a-image'); // Kunstwerk
    img.setAttribute('src', IMG_SRC);
    img.setAttribute('scale', TEST_SCALE);
    img.setAttribute('material','shader: flat; opacity: 1; transparent: false');
    img.setAttribute('look-at','[camera]');

    const frame = document.createElement('a-ring'); // pulsierender Rahmen
    frame.setAttribute('radius-inner','6.2');
    frame.setAttribute('radius-outer','6.6');
    frame.setAttribute('position','0 0 0.01');
    frame.setAttribute('material','color: #00ffff; shader: flat; opacity: 0.95; transparent: true');
    frame.setAttribute('animation__pulse','property=scale; to=1.08 1.08 1; dir=alternate; dur=600; loop=true; easing=easeInOutSine');

    localImgEl.appendChild(bg);
    localImgEl.appendChild(img);
    localImgEl.appendChild(frame);

    localImgEl.setAttribute('position','0 0 -1');   // 1 m vor dir
    mount.querySelector('a-scene').appendChild(localImgEl);

    statusEl.textContent = 'Test-Beacon 1 m vor dir platziert.';
  }catch(err){
    statusEl.textContent = 'Fehler beim Testmodus: ' + err.message;
  }
}

/*** Kamera + Sensors ***/
async function ensureCameraAndMotion(){
  await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
  try{
    if (typeof DeviceMotionEvent?.requestPermission === 'function') {
      await DeviceMotionEvent.requestPermission().catch(()=>{});
    }
    if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
      await DeviceOrientationEvent.requestPermission().catch(()=>{});
    }
  }catch(e){}
  startHeadingListeners();
}

/*** Standort einmalig holen ***/
function getOnceLocation(){
  return new Promise((res,rej)=>{
    if(!('geolocation' in navigator)) return rej(new Error('Geolocation nicht unterstÃ¼tzt'));
    navigator.geolocation.getCurrentPosition(res, e=>rej(new Error('Standort: '+e.message)),
      { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
  });
}

/*** AR-Szene aufbauen â€“ Geo-Bilder riesig + mit Glow-Backdrop ***/
function buildScene(){
  let imagesHtml = `
    <!-- Debug-WÃ¼rfel 3 m vor dir -->
    <a-box color="#00ffff" depth="1.2" height="1.2" width="1.2" position="0 0 -3"
           material="shader: flat; opacity: 0.9"></a-box>
  `;
  TARGETS.forEach((t,i)=>{
    imagesHtml += `
      <a-entity id="artTarget${i}" gps-entity-place="latitude: ${t.lat}; longitude: ${t.lon};">
        <a-plane width="36" height="27" position="0 0 -0.02"
                 material="shader: flat; color: #00ffff; opacity: 0.12; transparent: true"></a-plane>
        <a-image src="${IMG_SRC}" scale="${BIG_SCALE}" look-at="[gps-camera]"
                 material="shader: flat; opacity: 1"></a-image>
        <a-ring radius-inner="17" radius-outer="17.8" position="0 0 0.02"
                material="color: #00ffff; shader: flat; opacity: 0.95; transparent: true"
                animation__pulse="property=scale; to=1.06 1.06 1; dir=alternate; dur=700; loop=true; easing=easeInOutSine"></a-ring>
      </a-entity>
    `;
  });

  mount.innerHTML = `
    <a-scene embedded vr-mode-ui="enabled:false"
             renderer="antialias:true; alpha:true"
             arjs="sourceType: webcam; videoTexture:true; trackingMethod: best; facingMode: environment;">
      ${imagesHtml}
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>`;
  sceneEl = document.querySelector('a-scene');
}

/*** Live-Distanz + HUD-Pfeil ***/
function watchDistanceAndHeading(){
  if(!('geolocation' in navigator)) return;
  const R=6371e3, toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;

  const distM = (la1,lo1,la2,lo2)=>{
    const dLa=toRad(la2-la1), dLo=toRad(lo2-lo1);
    const a=Math.sin(dLa/2)**2+Math.cos(toRad(la1))*Math.cos(toRad(la2))*Math.sin(dLo/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  };
  const bearingDeg = (la1,lo1,la2,lo2)=>{
    const Ï†1=toRad(la1), Ï†2=toRad(la2), Î»1=toRad(lo1), Î»2=toRad(lo2);
    const y = Math.sin(Î»2-Î»1)*Math.cos(Ï†2);
    const x = Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1);
    let Î¸ = toDeg(Math.atan2(y,x));
    return (Î¸+360)%360; // 0..360
  };

  navigator.geolocation.watchPosition(
    p => {
      lastPos = p.coords;
      const { latitude, longitude, accuracy } = p.coords;

      // Distanzen & nÃ¤chster Spot
      const entries = TARGETS.map(t => ({
        name: t.name,
        d: distM(latitude, longitude, t.lat, t.lon),
        brg: bearingDeg(latitude, longitude, t.lat, t.lon)
      })).sort((a,b)=>a.d-b.d);

      const nearest = entries[0];
      nearestNameEl.textContent = nearest.name;

      // Distanz gut lesbar
      const dTxt = nearest.d >= 1000 ? (nearest.d/1000).toFixed(2)+' km' : nearest.d.toFixed(0)+' m';
      distEl.textContent = `Entfernung: ${dTxt} Â· GPS Â±${Math.round(accuracy)} m`;

      // Pfeil ausrichten (GerÃ¤te-Heading -> Ziel-Bearing)
      if (deviceHeadingDeg!=null){
        const turn = ((nearest.brg - deviceHeadingDeg) + 360) % 360; // wieviel Grad drehen
        arrowEl.style.transform = `rotate(${turn}deg)`;
      }
      statusEl.textContent = `NÃ¤chster: ${nearest.name} Â· Kurs: ${nearest.brg.toFixed(0)}Â° Â· Dein Heading: ${deviceHeadingDeg!=null?deviceHeadingDeg.toFixed(0)+'Â°':'â€“'}`;
    },
    e => { statusEl.textContent = 'Standort-Fehler: '+e.message; },
    { enableHighAccuracy:true, timeout:20000, maximumAge:0 }
  );
}

/*** Heading (Kompass) erfassen ***/
function startHeadingListeners(){
  // iOS (webkitCompassHeading)
  window.addEventListener('deviceorientation', e=>{
    if (typeof e.webkitCompassHeading === 'number'){
      deviceHeadingDeg = e.webkitCompassHeading; // 0=N
    }else if (e.absolute === true && typeof e.alpha === 'number'){
      // Fallback: alpha 0=N (kann je nach GerÃ¤t abweichen)
      deviceHeadingDeg = 360 - e.alpha; // in Kompassrichtung umdrehen
    }
  }, true);

  // Manche Browser feuern deviceorientationabsolute
  window.addEventListener('deviceorientationabsolute', e=>{
    if (typeof e.alpha === 'number'){
      deviceHeadingDeg = 360 - e.alpha;
    }
  }, true);
}
</script>
</body>
</html>
