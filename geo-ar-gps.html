<!-- /index.html -->
<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Geo-AR Debug â€“ sichtbar & nachvollziehbar</title>

<!-- A-Frame & AR.js (Geo) -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
<script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>

<!-- Firebase (ESM) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAd4_0zLdbI6jkjcZZUtMSWCYKP14dGHzQ",
    authDomain: "geo-ar-2c66d.firebaseapp.com",
    projectId: "geo-ar-2c66d",
    storageBucket: "geo-ar-2c66d.appspot.com",
    messagingSenderId: "232770478087",
    appId: "1:232770478087:web:d0d6cb8a585bdef5fdcaa2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window._db = db;
  window._fs = { collection, addDoc, getDocs, serverTimestamp };
</script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif}
  #overlay{position:fixed;inset:0;display:grid;place-items:center;background:#000c;z-index:20;text-align:center;padding:16px}
  .btn{padding:12px 14px;border:0;border-radius:12px;font-weight:800;color:#fff;background:#0ea5e9;margin:0 6px;cursor:pointer}
  #hud{position:fixed;top:84px;left:50%;transform:translateX(-50%);z-index:6;display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none}
  #arrow{width:96px;height:96px;filter:drop-shadow(0 0 8px #00ffff);transition:transform 80ms linear}
  #dist{font-size:18px;font-weight:900;background:#000c;padding:8px 12px;border-radius:999px}
  #corner{position:fixed;top:12px;right:12px;z-index:7;display:flex;gap:8px;align-items:center}
  .chip{background:#000d;border:1px solid #1f2937;color:#fff;padding:8px 10px;border-radius:10px;font-size:12px}
  #status{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);background:#000d;padding:10px 14px;border-radius:10px;z-index:6;white-space:nowrap;font-weight:700}
  /* Debug Panel */
  #debug{position:fixed;left:12px;top:12px;z-index:15;background:#000d;border:1px solid #1f2937;padding:10px 12px;border-radius:12px;max-width:320px;font-size:12px;line-height:1.3}
  #debug h3{margin:0 0 6px;font-size:13px}
  #debug .row{display:flex;justify-content:space-between;gap:8px}
  #debug .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  #calib{margin-top:8px;display:flex;align-items:center;gap:8px}
  #calib input[type=range]{width:160px}
</style>
</head>
<body>

<!-- Intro -->
<div id="overlay">
  <div>
    <h1 style="margin:0 0 8px">Geo-AR starten (Debug)</h1>
    <p style="opacity:.9;max-width:640px;margin:0 auto 14px">
      Erlaube <b>Kamera</b>, <b>Standort</b> und ggf. <b>Bewegungssensor</b> (iOS).<br>
      Debug zeigt dir Live-Daten. Ein <b>Test-WÃ¼rfel</b> steht 1 m vor dir.
    </p>
    <button id="start" class="btn">Los gehtâ€™s</button>
    <button id="admin" class="btn" style="background:#ef4444">Spot setzen (Admin)</button>
  </div>
</div>

<!-- Debug Panel -->
<div id="debug" hidden>
  <h3>ðŸ”Ž Debug</h3>
  <div class="row"><span>GPS:</span><span class="mono" id="dbgGps">â€“</span></div>
  <div class="row"><span>Acc:</span><span class="mono" id="dbgAcc">â€“</span></div>
  <div class="row"><span>Heading:</span><span class="mono" id="dbgHead">â€“</span></div>
  <div class="row"><span>Nearest:</span><span class="mono" id="dbgNearest">â€“</span></div>
  <div class="row"><span>AR Fix:</span><span class="mono" id="dbgFix">pendingâ€¦</span></div>
  <div id="calib">
    <span>Kalibrier-Offset:</span>
    <input id="offset" type="range" min="-45" max="45" step="1" value="0" />
    <button id="zero" class="btn" style="padding:6px 10px;background:#10b981">0Â°</button>
  </div>
</div>

<!-- Corner HUD -->
<div id="corner"><div class="chip">ðŸŽ¯ NÃ¤chster Spot: <span id="nearestName">â€“</span></div></div>

<!-- Direction HUD -->
<div id="hud">
  <svg id="arrow" viewBox="0 0 100 100" aria-label="Richtung zum Spot">
    <polygon points="50,5 80,55 60,55 60,95 40,95 40,55 20,55" fill="#00ffff" opacity="0.95"/>
  </svg>
  <div id="dist">Entfernung: â€“</div>
</div>

<div id="status">Bereitâ€¦</div>
<div id="mount"></div>

<script type="module">
/*** Firebase handles ***/
const { collection, addDoc, getDocs, serverTimestamp } = window._fs;
const db = window._db;

/*** UI ***/
const mount    = document.getElementById('mount');
const overlay  = document.getElementById('overlay');
const statusEl = document.getElementById('status');
const arrowEl  = document.getElementById('arrow');
const distEl   = document.getElementById('dist');
const nearestNameEl = document.getElementById('nearestName');
const dbg       = document.getElementById('debug');
const dbgGps    = document.getElementById('dbgGps');
const dbgAcc    = document.getElementById('dbgAcc');
const dbgHead   = document.getElementById('dbgHead');
const dbgNearest= document.getElementById('dbgNearest');
const dbgFix    = document.getElementById('dbgFix');
const offsetInp = document.getElementById('offset');
const zeroBtn   = document.getElementById('zero');

/*** Config ***/
const IMG_SRC   = "https://galgental9ps-png.github.io/atelier-api/echo_der_gedanken.jpg";
const BIG_SCALE = "34 25.5 1";

const BASE_TARGETS = [
  { name: 'Altstadt-Spot',         lat: 48.366184, lon: 10.867701 },
  { name: 'StettenstraÃŸe 7',       lat: 48.368905, lon: 10.898445 },
  { name: 'Neuer Spot',            lat: 48.36630,  lon: 10.86781  },
  { name: 'GabelsbergerstraÃŸe 64', lat: 48.33598,  lon: 10.86728  }
];
let REMOTE_TARGETS = [];

/*** State ***/
let sceneEl, started=false, deviceHeadingDeg=null, geoWatchId=null, firstGpsFix=false, headingOffset=0;

/*** Buttons ***/
document.getElementById('start').addEventListener('click', startViewer);
document.getElementById('admin').addEventListener('click', startAdmin);
offsetInp.addEventListener('input', ()=>{ headingOffset = Number(offsetInp.value)||0; });
zeroBtn.addEventListener('click', ()=>{ headingOffset=0; offsetInp.value=0; });

/*** Start: Viewer ***/
async function startViewer(){
  try{
    await ensureCameraAndMotion();
    ensureScene();
    overlay.style.display='none';
    dbg.hidden=false;

    // 1) Test-WÃ¼rfel 1m vor Kamera (zeigt: Rendering ok?)
    addLocalTestBox();

    // 2) Auf ersten AR.js-GPS-Fix warten (stabilere Geo-UrsprÃ¼nge)
    await waitForFirstGpsFix();

    // 3) Erst danach Spots einfÃ¼gen
    await loadRemoteSpots();
    [...BASE_TARGETS, ...REMOTE_TARGETS].forEach(t => appendSpotEntity(t));

    // 4) HUD updaten
    await ensureGeoWatch();
    started=true;
    statusEl.textContent='Viewer aktiv. Achte auf Debug-Werte & Pfeil.';
  }catch(e){
    console.error(e);
    statusEl.textContent='Start-Fehler: '+e.message;
  }
}

/*** Start: Admin (Spot speichern) ***/
async function startAdmin(){
  const pw = prompt('Admin-Passwort:');
  if(pw!=='1234'){ alert('Falsches Passwort'); return; }

  try{
    await ensureCameraAndMotion();
    ensureScene();
    overlay.style.display='none';
    dbg.hidden=false;

    const pos = await getOnceLocation();
    const { latitude, longitude, accuracy } = pos.coords;

    await addDoc(collection(db,'spots'),{
      name:'Echo der Gedanken',
      img: IMG_SRC,
      lat: Number(latitude.toFixed(6)),
      lon: Number(longitude.toFixed(6)),
      createdAt: serverTimestamp()
    });

    appendSpotEntity({ name:'Echo der Gedanken', img:IMG_SRC, lat:latitude, lon:longitude });

    statusEl.textContent = `Gespeichert: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (Â±${Math.round(accuracy)} m)`;
  }catch(e){
    console.error(e);
    statusEl.textContent = 'Admin-Fehler: '+e.message;
  }
}

/*** Scene (neuer Geo-Pfad + Debug-AR) ***/
function ensureScene(){
  if(sceneEl) return;
  mount.innerHTML = `
    <a-scene embedded vr-mode-ui="enabled:false"
      renderer="antialias:true; alpha:true"
      arjs="sourceType: webcam; videoTexture:true; debugUIEnabled:false; trackingMethod: best;">
      <a-camera
        gps-new-camera="gpsMinDistance:0; gpsTimeInterval:1000; positionMinAccuracy:100"
        rotation-reader
      ></a-camera>
    </a-scene>`;
  sceneEl = document.querySelector('a-scene');
  startHeadingListeners();
}

/*** Warte auf 1. GPS-Fix der AR-Kamera (wichtig: Weltursprung) ***/
function waitForFirstGpsFix(){
  return new Promise((res, rej)=>{
    const cam = sceneEl.querySelector('[gps-new-camera]');
    if(!cam) return rej(new Error('Geo-Kamera nicht gefunden'));
    const onFix = (e)=>{
      firstGpsFix = true;
      dbgFix.textContent = 'ok';
      cam.removeEventListener('gps-camera-update-position', onFix);
      res();
    };
    cam.addEventListener('gps-camera-update-position', onFix, { once:true });
    setTimeout(()=>{ if(!firstGpsFix){ dbgFix.textContent='timeout (weiter)'; res(); } }, 5000);
  });
}

/*** Test-Objekt 1m vor dir (sanity check) ***/
function addLocalTestBox(){
  const box = document.createElement('a-box');
  box.setAttribute('position','0 0 -1');            // 1 m vor Kamera
  box.setAttribute('depth','0.2'); box.setAttribute('height','0.2'); box.setAttribute('width','0.2');
  box.setAttribute('material','color:#ffffff; opacity:0.95; transparent:true');
  box.setAttribute('id','localBox');
  sceneEl.appendChild(box);
}

/*** Geo-Entity (neuer Attribut-Name) ***/
function appendSpotEntity(d){
  if(Number.isFinite(d.lat)&&Number.isFinite(d.lon)){
    const el=document.createElement('a-entity');
    el.setAttribute('gps-new-entity-place',`latitude: ${d.lat}; longitude: ${d.lon};`);

    const plane = document.createElement('a-plane');
    plane.setAttribute('width','36'); plane.setAttribute('height','27');
    plane.setAttribute('position','0 0 -0.02');
    plane.setAttribute('material','shader: flat; color: #00ffff; opacity: 0.12; transparent:true; side: double');
    plane.setAttribute('look-at','[gps-new-camera]');

    const img = document.createElement('a-image');
    img.setAttribute('src', d.img||IMG_SRC);
    img.setAttribute('scale', BIG_SCALE);
    img.setAttribute('material','shader: flat; opacity:1; side: double');
    img.setAttribute('look-at','[gps-new-camera]');

    const ring = document.createElement('a-ring');
    ring.setAttribute('radius-inner','17'); ring.setAttribute('radius-outer','17.8');
    ring.setAttribute('position','0 0 0.02');
    ring.setAttribute('material','color:#00ffff; shader:flat; opacity:0.95; transparent:true; side: double');
    ring.setAttribute('animation__pulse','property=scale; to=1.06 1.06 1; dir=alternate; dur=700; loop=true; easing=easeInOutSine');

    el.appendChild(plane); el.appendChild(img); el.appendChild(ring);
    sceneEl.appendChild(el);
  }
}

/*** Firestore ***/
async function loadRemoteSpots(){
  try{
    const snap = await getDocs(collection(db,'spots'));
    REMOTE_TARGETS = snap.docs.map(d=>{
      const x=d.data(); return { name:x.name||'Spot', img:x.img||IMG_SRC, lat:x.lat, lon:x.lon };
    });
  }catch(e){
    console.warn('Spots laden fehlgeschlagen:', e);
  }
}

/*** Kamera + Sensoren ***/
async function ensureCameraAndMotion(){
  await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
  try{
    if(typeof DeviceMotionEvent?.requestPermission === 'function'){ await DeviceMotionEvent.requestPermission().catch(()=>{}); }
    if(typeof DeviceOrientationEvent?.requestPermission === 'function'){ await DeviceOrientationEvent.requestPermission().catch(()=>{}); }
  }catch(e){}
}

/*** GPS einmalig ***/
function getOnceLocation(){
  return new Promise((res,rej)=>{
    if(!('geolocation' in navigator)) return rej(new Error('Geolocation nicht unterstÃ¼tzt'));
    navigator.geolocation.getCurrentPosition(res, e=>rej(new Error(e.message)),
      { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
  });
}

/*** GPS-Watch fÃ¼r HUD ***/
function ensureGeoWatch(){
  return new Promise((resolve,reject)=>{
    if(!('geolocation' in navigator)) return reject(new Error('Geolocation nicht unterstÃ¼tzt'));
    navigator.geolocation.getCurrentPosition(p=>{
      if(geoWatchId!=null) navigator.geolocation.clearWatch(geoWatchId);
      geoWatchId = navigator.geolocation.watchPosition(
        pos=>{ updateHud(pos.coords); },
        err=>{ statusEl.textContent='GPS-Fehler: '+err.message; },
        { enableHighAccuracy:true, timeout:20000, maximumAge:0 }
      );
      updateHud(p.coords);
      resolve();
    },err=>reject(err),{ enableHighAccuracy:true, timeout:15000, maximumAge:0 });
  });
}

/*** HUD & Debug: Distanz + Richtung ***/
function updateHud(coords){
  const all=[...BASE_TARGETS, ...REMOTE_TARGETS];
  if(!all.length) return;

  const { latitude, longitude, accuracy } = coords;

  // Sichtbarkeitshinweis bei schlechter Accuracy (warum: groÃŸe VersÃ¤tze)
  if(accuracy>100){
    statusEl.textContent = `GPS ungenau (Â±${Math.round(accuracy)} m) â€“ warte auf besseren Fixâ€¦`;
  }

  const nearest = all
    .map(t=>({ t, d: distM(latitude, longitude, t.lat, t.lon), brg: bearing(latitude, longitude, t.lat, t.lon) }))
    .sort((a,b)=>a.d-b.d)[0];

  nearestNameEl.textContent = nearest.t.name || 'Spot';
  const txt = nearest.d>=1000 ? (nearest.d/1000).toFixed(2)+' km' : Math.round(nearest.d)+' m';
  distEl.textContent = `Entfernung: ${txt} Â· GPS Â±${Math.round(accuracy)} m`;

  const heading = (deviceHeadingDeg!=null) ? wrap360(deviceHeadingDeg + headingOffset) : null;
  if (heading!=null){
    const turn = ((nearest.brg - heading)+360)%360;
    arrowEl.style.transform=`rotate(${turn}deg)`;
  }

  // Debug Infos
  dbgGps.textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
  dbgAcc.textContent = `Â±${Math.round(accuracy)} m`;
  dbgHead.textContent= heading!=null ? `${heading.toFixed(0)}Â°` : 'â€“';
  dbgNearest.textContent = `${nearest.t.name} â€¢ ${txt} â€¢ Kurs ${nearest.brg.toFixed(0)}Â°`;

  statusEl.textContent = `Kurs: ${nearest.brg.toFixed(0)}Â° Â· Heading: ${heading!=null?heading.toFixed(0)+'Â°':'â€“'}`;
}

/*** Kompass ***/
function startHeadingListeners(){
  window.addEventListener('deviceorientation', e=>{
    if (typeof e.webkitCompassHeading === 'number'){
      deviceHeadingDeg = e.webkitCompassHeading; // iOS
    }else if (e.absolute===true && typeof e.alpha === 'number'){
      deviceHeadingDeg = 360 - e.alpha; // Android (ungefÃ¤hr)
    }
  }, true);
  window.addEventListener('deviceorientationabsolute', e=>{
    if (typeof e.alpha === 'number'){ deviceHeadingDeg = 360 - e.alpha; }
  }, true);
}

/*** Geo-Math ***/
const toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
function distM(la1,lo1,la2,lo2){
  const R=6371e3, dLa=toRad(la2-la1), dLo=toRad(lo2-lo1);
  const a=Math.sin(dLa/2)**2+Math.cos(toRad(la1))*Math.cos(toRad(la2))*Math.sin(dLo/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function bearing(la1,lo1,la2,lo2){
  const Ï†1=toRad(la1), Ï†2=toRad(la2), Î»1=toRad(lo1), Î»2=toRad(lo2);
  const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2);
  const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1);
  return (toDeg(Math.atan2(y,x))+360)%360;
}
function wrap360(v){ v%=360; return v<0?v+360:v; }
</script>
</body>
</html>
