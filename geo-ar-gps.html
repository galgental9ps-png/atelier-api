<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Geo-AR – Echo der Gedanken (4 Spots)</title>

<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;
    font-family:-apple-system,system-ui,Segoe UI,Inter,Roboto,sans-serif}
  #overlay{position:fixed;inset:0;display:grid;place-items:center;
    background:linear-gradient(#0009,#0009);z-index:10;text-align:center;padding:16px}
  .btn{padding:12px 14px;border:0;border-radius:12px;font-weight:700;color:#fff;background:#0ea5e9;margin:0 6px}
  #status{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);
    background:#0009;padding:8px 12px;border-radius:8px;z-index:5;white-space:nowrap}
</style>
</head>
<body>

<div id="overlay">
  <div>
    <h1 style="margin:0 0 8px">Geo-AR starten</h1>
    <p style="opacity:.85;max-width:560px;margin:0 auto 12px">
      Erlaube Kamera, Bewegungssensor (iOS) und Standort.  
      Objekte stehen an <b>4 Positionen in Augsburg</b>.  
      Zum schnellen Test: „Hier testen“ (1 m vor dir).
    </p>
    <button id="start" class="btn">Los geht’s</button>
    <button id="spawnHere" class="btn" style="background:#10b981">Hier testen</button>
  </div>
</div>

<div id="status">Bereit…</div>
<div id="mount"></div>

<script>
const IMG_SRC = 'https://galgental9ps-png.github.io/atelier-api/echo_der_gedanken.jpg';

// Vier feste GPS-Ziele
const TARGETS = [
  { name: 'Altstadt-Spot',        lat: 48.366184, lon: 10.867701 },
  { name: 'Neuer Spot',           lat: 48.36630,  lon: 10.86781  },
  { name: 'Stettenstraße 7',      lat: 48.368905, lon: 10.898445 },
  { name: 'Gabelsbergerstraße 64',lat: 48.33598,  lon: 10.86728  }
];

const statusEl = document.getElementById('status');
const mount    = document.getElementById('mount');
const overlay  = document.getElementById('overlay');
let sceneEl, localImgEl;

document.getElementById('start').addEventListener('click', init);
document.getElementById('spawnHere').addEventListener('click', spawnHere);

async function init(){
  try{
    await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
    await requestMotionIfNeeded();
    await getOnceLocation();
    overlay.style.display = 'none';
    buildScene();
    watchDistance();
  }catch(err){
    statusEl.textContent = 'Fehler: ' + err.message;
  }
}

function requestMotionIfNeeded(){
  return new Promise(async (resolve)=> {
    try{
      if (typeof DeviceMotionEvent?.requestPermission === 'function') {
        await DeviceMotionEvent.requestPermission().catch(()=>{});
      }
      if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
        await DeviceOrientationEvent.requestPermission().catch(()=>{});
      }
    }catch(e){}
    resolve();
  });
}

function getOnceLocation(){
  return new Promise((res,rej)=>{
    if(!('geolocation' in navigator)) return rej(new Error('Geolocation nicht unterstützt'));
    navigator.geolocation.getCurrentPosition(res, e=>rej(new Error('Standort: '+e.message)),
      { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
  });
}

function buildScene(){
  let imagesHtml = `
    <!-- Debug-Würfel 3 m vor dir -->
    <a-box color="#00ffff" depth="1.2" height="1.2" width="1.2" position="0 0 -3"
           material="shader: flat; opacity: 0.9"></a-box>
  `;
  TARGETS.forEach((t,i)=>{
    imagesHtml += `
      <a-entity id="artTarget${i}" gps-entity-place="latitude: ${t.lat}; longitude: ${t.lon};">
        <a-plane width="36" height="27" position="0 0 -0.02"
                 material="shader: flat; color: #00ffff; opacity: 0.12; transparent: true"></a-plane>
        <a-image src="${IMG_SRC}" scale="34 25.5 1" look-at="[gps-camera]"
                 material="shader: flat; opacity: 1"></a-image>
        <a-ring radius-inner="17" radius-outer="17.8" position="0 0 0.02"
                material="color: #00ffff; shader: flat; opacity: 0.95; transparent: true"
                animation__pulse="property=scale; to=1.06 1.06 1; dir=alternate; dur=700; loop=true; easing=easeInOutSine"></a-ring>
      </a-entity>`;
  });

  mount.innerHTML = `
    <a-scene embedded vr-mode-ui="enabled:false"
             renderer="antialias:true; alpha:true"
             arjs="sourceType: webcam; videoTexture:true; trackingMethod: best; facingMode: environment;">
      ${imagesHtml}
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>`;
  sceneEl = document.querySelector('a-scene');
}

// Distanz im Status anzeigen
function watchDistance(){
  if(!('geolocation' in navigator)) return;
  const R=6371e3, toRad=d=>d*Math.PI/180;
  const distM = (la1,lo1,la2,lo2)=>{
    const dLa=toRad(la2-la1), dLo=toRad(lo2-lo1);
    const a=Math.sin(dLa/2)**2+Math.cos(toRad(la1))*Math.cos(toRad(la2))*Math.sin(dLo/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  };
  navigator.geolocation.watchPosition(
    p => {
      const { latitude, longitude, accuracy } = p.coords;
      const entries = TARGETS.map(t => ({
        name: t.name,
        d: distM(latitude, longitude, t.lat, t.lon)
      })).sort((a,b)=>a.d-b.d);
      const nearest = entries[0];
      const list = entries.map(e => `${e.name}: ${e.d.toFixed(1)} m`).join(' | ');
      statusEl.textContent = `GPS ±${Math.round(accuracy)} m · ${list} · Nächster: ${nearest.name}`;
    },
    e => { statusEl.textContent = 'Standort-Fehler: '+e.message; },
    { enableHighAccuracy:true, timeout:20000, maximumAge:0 }
  );
}

// „Hier testen“: Bild 1 m vor dir
function spawnHere(){
  if(!sceneEl){
    statusEl.textContent = 'Erst „Los geht’s“ tippen (Kamera/Standort).';
    return;
  }
  if(localImgEl){ localImgEl.remove(); }
  localImgEl = document.createElement('a-image');
  localImgEl.setAttribute('src', IMG_SRC);
  localImgEl.setAttribute('position', '0 0 -1');
  localImgEl.setAttribute('scale', '12 9 1');
  localImgEl.setAttribute('material','shader: flat; opacity: 1; depthTest: false');
  sceneEl.appendChild(localImgEl);
  statusEl.textContent = 'Testbild 1 m vor dir platziert.';
}
</script>
</body>
</html>
