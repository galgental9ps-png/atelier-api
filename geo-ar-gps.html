<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web-AR (AR.js) – Marker + GPS</title>

<!-- A-Frame + AR.js -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
<!-- Blick-zu-Kamera für Billboard -->
<script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:system-ui,Inter,Roboto}
  #top{position:fixed;top:8px;left:50%;transform:translateX(-50%);z-index:20;background:#000a;border:1px solid #333;border-radius:10px;padding:6px 10px;font-size:13px}
  #bar{position:fixed;inset:auto 0 0 0;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;background:#000c;padding:10px;z-index:20;border-top:1px solid #1f2937}
  button{padding:10px 12px;border:0;border-radius:10px;background:#0ea5e9;color:#fff;font-weight:800}
  .alt{background:#10b981}.warn{background:#f59e0b}
  #hud{position:fixed;top:70px;left:50%;transform:translateX(-50%);z-index:20;display:flex;flex-direction:column;align-items:center;gap:8px}
  #arrow{width:88px;height:88px;filter:drop-shadow(0 0 8px #00ffff);transition:transform 80ms linear}
  #dist{font-size:14px;background:#000a;padding:6px 10px;border-radius:999px}
  a-scene{position:fixed;inset:0}
  #hiro{position:fixed;top:8px;left:8px;z-index:21;background:#111;padding:6px 10px;border-radius:8px;border:1px solid #333;display:none}
  #httpsWarn{position:fixed;top:8px;right:8px;z-index:21;background:#7f1d1d;color:#fff;padding:6px 10px;border-radius:8px;display:none}
</style>
</head>
<body>

<div id="top">Tipps: HTTPS, Kamera erlauben, iOS: Einstellungen → Safari → „Bewegung & Orientierung“ aktivieren.</div>
<div id="hiro">Marker nötig: <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/HIRO.jpg" target="_blank" style="color:#0ea5e9">HIRO anzeigen</a></div>
<div id="httpsWarn">⚠️ Ohne HTTPS verweigern Browser die Kamera/Geodaten.</div>

<div id="hud" style="display:none">
  <svg id="arrow" viewBox="0 0 100 100"><polygon points="50,5 80,55 60,55 60,95 40,95 40,55 20,55" fill="#00ffff" opacity="0.95"/></svg>
  <div id="dist">–</div>
</div>

<div id="bar">
  <button id="btn1" class="warn">1) Marker-AR (HIRO)</button>
  <button id="btn2" class="alt">2) Location-AR (GPS)</button>
  <button id="sensor" title="iOS/Android Sensorfreigabe">Sensor erlauben</button>
</div>

<div id="stage"></div>

<script>
/* ===== Grundchecks ===== */
if(!(location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1')){
  document.getElementById('httpsWarn').style.display='block';
}

/* ===== Sensorfreigabe (iOS/Android) ===== */
async function askSensors(){
  try{
    if (typeof DeviceMotionEvent?.requestPermission === 'function'){ await DeviceMotionEvent.requestPermission().catch(()=>{}); }
    if (typeof DeviceOrientationEvent?.requestPermission === 'function'){ await DeviceOrientationEvent.requestPermission().catch(()=>{}); }
  }catch(e){}
}
document.getElementById('sensor').addEventListener('click', askSensors);

/* ===== Kamera explizit anfragen (hilft manchen Browsern) ===== */
async function ensureCam(){
  try{
    await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
  }catch(e){
    alert('Kamera konnte nicht gestartet werden: '+e.message);
  }
}

/* ===== GEO + KOMPASS für HUD ===== */
let deviceHeadingDeg = null, geoWatchId = null;
const hud = document.getElementById('hud');
const arrowEl = document.getElementById('arrow');
const distEl = document.getElementById('dist');

function startHeading(){
  window.addEventListener('deviceorientation', e=>{
    if (typeof e.webkitCompassHeading === 'number'){ deviceHeadingDeg = e.webkitCompassHeading; }
    else if (e.absolute===true && typeof e.alpha==='number'){ deviceHeadingDeg = 360 - e.alpha; }
  }, true);
}
function ensureGeoWatch(updateFn){
  if(!('geolocation' in navigator)){ alert('Geolocation nicht unterstützt'); return; }
  navigator.geolocation.getCurrentPosition(p=>{
    updateFn(p.coords);
    if(geoWatchId!=null) navigator.geolocation.clearWatch(geoWatchId);
    geoWatchId = navigator.geolocation.watchPosition(
      pos=>updateFn(pos.coords),
      err=>{ distEl.textContent='GPS-Fehler: '+err.message; },
      { enableHighAccuracy:true, timeout:20000, maximumAge:0 }
    );
  }, err=>alert('GPS-Fehler: '+err.message), { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
}

const toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
function distM(la1,lo1,la2,lo2){
  const R=6371e3, dLa=toRad(la2-la1), dLo=toRad(lo2-lo1);
  const a=Math.sin(dLa/2)**2+Math.cos(toRad(la1))*Math.cos(toRad(la2))*Math.sin(dLo/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function bearing(la1,lo1,la2,lo2){
  const φ1=toRad(la1), φ2=toRad(la2), λ1=toRad(lo1), λ2=toRad(lo2);
  const y=Math.sin(λ2-λ1)*Math.cos(φ2);
  const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*cos(φ2)*Math.cos(λ2-λ1);
  return (toDeg(Math.atan2(y,x))+360)%360;
}
function cos(x){ return Math.cos(x); }

/* ===== Deine GPS-Spots (hier editierbar) ===== */
const TARGETS = [
  { name: 'Altstadt-Spot',         lat: 48.366184, lon: 10.867701 },
  { name: 'Stettenstraße 7',       lat: 48.368905, lon: 10.898445 },
  { name: 'Neuer Spot',            lat: 48.36630,  lon: 10.86781  },
  { name: 'Gabelsbergerstraße 64', lat: 48.33598,  lon: 10.86728  }
];
// Optional: Firestore-Spots hinzuladen und TARGETS erweitern (du hast das schon) – hier weggelassen, um es simpel zu halten.

/* ====================================================================== */
/* 1) MARKER-AR (HIRO) – robust                                           */
/* ====================================================================== */
document.getElementById('btn1').addEventListener('click', async ()=>{
  await ensureCam(); await askSensors();
  document.getElementById('hiro').style.display='block';
  hud.style.display='none';
  document.getElementById('stage').innerHTML = `
    <a-scene embedded vr-mode-ui="enabled:false" renderer="antialias:true; alpha:true"
      arjs="sourceType: webcam; detectionMode: mono; matrixCodeType: 3x3; debugUIEnabled:false;">
      
      <!-- Riesenwürfel auf dem Marker -->
      <a-marker preset="hiro">
        <a-entity scale="3 3 3">
          <a-box position="0 0.5 0" width="1.6" height="1.6" depth="1.6"
                 material="color:#00ffff; opacity:0.95; shader:flat"
                 animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear"></a-box>
        </a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  `;
});

/* ====================================================================== */
/* 2) LOCATION-AR (GPS) – AR.js gps-entity-place                          */
/* ====================================================================== */
document.getElementById('btn2').addEventListener('click', async ()=>{
  await ensureCam(); await askSensors(); startHeading();
  hud.style.display='block';
  document.getElementById('hiro').style.display='none';

  // Szene
  document.getElementById('stage').innerHTML = `
    <a-scene embedded vr-mode-ui="enabled:false" renderer="antialias:true; alpha:true"
      arjs="sourceType: webcam; videoTexture:true; trackingMethod: best; facingMode: environment;">
      
      <!-- Hinweis: nahe/far Clip groß setzen, damit Distanzen nicht wegclippen -->
      <a-camera gps-camera="gpsMinDistance: 0; gpsTimeInterval: 1000" near="0.01" far="100000" rotation-reader></a-camera>
    </a-scene>
  `;
  const scene = document.querySelector('a-scene');

  // Sehr großes Billboard für JEDE Koordinate
  TARGETS.forEach((t,i)=>{
    const holder = document.createElement('a-entity');
    holder.setAttribute('gps-entity-place', `latitude: ${t.lat}; longitude: ${t.lon};`);

    const bg = document.createElement('a-plane');
    bg.setAttribute('width','36');
    bg.setAttribute('height','27');
    bg.setAttribute('position','0 0 -0.02');
    bg.setAttribute('material','shader: flat; color: #00ffff; opacity: 0.12; transparent: true; side: double');
    bg.setAttribute('look-at','[gps-camera]');

    const cube = document.createElement('a-box');
    cube.setAttribute('width','6'); cube.setAttribute('height','6'); cube.setAttribute('depth','6');
    cube.setAttribute('position','0 3 0');
    cube.setAttribute('material','color:#00ffff; opacity:0.95; shader:flat; side: double');
    cube.setAttribute('animation','property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear');

    const ring = document.createElement('a-ring');
    ring.setAttribute('radius-inner','3.2'); ring.setAttribute('radius-outer','3.8');
    ring.setAttribute('position','0 0 0.02');
    ring.setAttribute('material','color:#00ffff; shader:flat; opacity:0.95; transparent:true; side: double');
    ring.setAttribute('animation__pulse','property=scale; to=1.06 1.06 1; dir=alternate; dur:800; loop:true; easing=easeInOutSine');

    const label = document.createElement('a-text');
    label.setAttribute('value', t.name);
    label.setAttribute('color', '#00ffff');
    label.setAttribute('position', '0 7 0.02');
    label.setAttribute('width', '12');
    label.setAttribute('align', 'center');
    label.setAttribute('look-at', '[gps-camera]');

    holder.appendChild(bg);
    holder.appendChild(cube);
    holder.appendChild(ring);
    holder.appendChild(label);
    scene.appendChild(holder);
  });

  // HUD: Distanz/Richtung zum NÄCHSTEN Spot und Pfeil
  ensureGeoWatch(coords=>{
    const { latitude, longitude, accuracy } = coords;
    const list = TARGETS.map(t=>{
      const d = distM(latitude, longitude, t.lat, t.lon);
      const brg = bearing(latitude, longitude, t.lat, t.lon);
      return { t, d, brg };
    }).sort((a,b)=>a.d-b.d);

    const nearest = list[0];
    const text = nearest.d>=1000 ? (nearest.d/1000).toFixed(2)+' km' : Math.round(nearest.d)+' m';
    distEl.textContent = `🎯 ${nearest.t.name} • Entfernung: ${text} • GPS ±${Math.round(accuracy)} m`;

    if (deviceHeadingDeg!=null){
      const turn=((nearest.brg - deviceHeadingDeg)+360)%360;
      arrowEl.style.transform=`rotate(${turn}deg)`;
    }
  });
});
</script>
</body>
</html>
