<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Geo-AR mit Firebase</title>

<!-- A-Frame & AR.js -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ðŸ”‘ Deine Firebase-Konfiguration
  const firebaseConfig = {
    apiKey: "AIzaSyAd4_0zLdbI6jkjcZZUtMSWCYKP14dGHzQ",
    authDomain: "geo-ar-2c66d.firebaseapp.com",
    projectId: "geo-ar-2c66d",
    storageBucket: "geo-ar-2c66d.appspot.com",
    messagingSenderId: "232770478087",
    appId: "1:232770478087:web:d0d6cb8a585bdef5fdcaa2"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Refs
  const overlay = document.getElementById("overlay");
  const statusEl = document.getElementById("status");
  const mount = document.getElementById("mount");

  // Buttons
  document.getElementById("start").addEventListener("click", async ()=>{
    overlay.style.display = "none";
    buildScene();
    await loadSpots();
  });

  document.getElementById("setSpot").addEventListener("click", async ()=>{
    const pw = prompt("Passwort eingeben:");
    if(pw !== "1234"){ alert("Falsches Passwort"); return; }

    if(!("geolocation" in navigator)){
      alert("Geolocation nicht unterstÃ¼tzt"); return;
    }

    navigator.geolocation.getCurrentPosition(async pos=>{
      try{
        await addDoc(collection(db,"spots"),{
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          ts: Date.now()
        });
        alert("Spot gespeichert! Seite neu laden um ihn zu sehen.");
      }catch(e){
        alert("Fehler beim Speichern: "+e.message);
      }
    }, err=>alert("Standortfehler: "+err.message),
    { enableHighAccuracy:true });
  });

  // Szene bauen
  function buildScene(){
    mount.innerHTML = `
      <a-scene embedded
        vr-mode-ui="enabled:false"
        renderer="antialias:true; alpha:true"
        arjs="sourceType: webcam; videoTexture:true; trackingMethod: best; facingMode: environment;">
        <a-camera gps-camera rotation-reader></a-camera>
      </a-scene>`;
  }

  // Spots laden und einfÃ¼gen
  async function loadSpots(){
    const scene = document.querySelector("a-scene");
    const q = await getDocs(collection(db,"spots"));
    q.forEach(doc=>{
      const d = doc.data();
      const box = document.createElement("a-box");
      box.setAttribute("gps-entity-place", `latitude: ${d.lat}; longitude: ${d.lon};`);
      box.setAttribute("material","color:#00ffff; opacity:0.9; shader:flat;");
      box.setAttribute("scale","6 6 6");
      box.setAttribute("animation","property=rotation; to:0 360 0; loop:true; dur:6000; easing=linear");
      scene.appendChild(box);
    });
    statusEl.textContent = q.size+" Spots geladen.";
  }
</script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:system-ui}
  #overlay{position:fixed;inset:0;display:grid;place-items:center;background:#000c;z-index:10;text-align:center}
  .btn{padding:12px 16px;margin:6px;border:0;border-radius:12px;font-weight:700;color:#fff;background:#0ea5e9}
  #status{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:#000a;padding:6px 12px;border-radius:8px;z-index:5}
</style>
</head>
<body>
  <div id="overlay">
    <div>
      <h1>Geo-AR starten</h1>
      <p>â€žLos gehtâ€™sâ€œ â†’ gespeicherte Spots werden angezeigt.<br>â€žSpot setzenâ€œ â†’ neuen Spot an deinem Standort speichern (PW: 1234).</p>
      <button id="start" class="btn">Los gehtâ€™s</button>
      <button id="setSpot" class="btn" style="background:#10b981">Spot setzen</button>
    </div>
  </div>

  <div id="status">Bereitâ€¦</div>
  <div id="mount"></div>
</body>
</html>
