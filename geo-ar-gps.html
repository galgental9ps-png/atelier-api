<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WebAR – Bild nahe Kamera (Sofort sichtbar)</title>

<!-- A‑Frame (WebXR) -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif}
  #ui{position:fixed;inset:auto 0 0 0;display:flex;gap:10px;justify-content:center;padding:12px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.6));z-index:10}
  .btn{padding:10px 14px;border:0;border-radius:12px;font-weight:800;color:#fff;background:#0ea5e9;cursor:pointer}
  #hint{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#000c;padding:8px 12px;border-radius:999px;z-index:10;font-weight:700}
</style>
</head>
<body>

<div id="hint">AR startet & zeigt das Bild direkt vor der Kamera. Mit den Buttons kannst du es näher/weiter positionieren.</div>
<div id="reticle" aria-hidden="true"></div>
<div id="ui">
  <button id="start" class="btn">AR starten</button>
  <button id="near" class="btn">Näher</button>
  <button id="far" class="btn">Weiter</button>
  <button id="center" class="btn">Zentrieren</button>
  <button id="clear" class="btn" style="background:#ef4444">Entfernen</button>
</div>

<a-scene 
  renderer="antialias:true; alpha:true" 
  embedded
  xr="optionalFeatures: hit-test, dom-overlay; overlayElement: #ui"
  webxr="optionalFeatures: hit-test, dom-overlay"
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:true">

  <a-entity id="cameraRig">
    <a-camera id="camera" wasd-controls-enabled="false" position="0 1.6 0"></a-camera>
  </a-entity>

  <!-- Container fürs platzierte Objekt -->
  <a-entity id="art"></a-entity>

  <!-- sanftes Umgebungslicht -->
  <a-entity light="type: ambient; intensity: 1.0"></a-entity>
</a-scene>

<script>
// === Einstellungen ===
const IMG_SRC = "https://galgental9ps-png.github.io/atelier-api/echo_der_gedanken.jpg"; // Dein Bild
const IMG_W   = 1.2;  // Breite in Metern
const IMG_H   = 0.9;  // Höhe in Metern
const MIN_D   = 0.4;  // Minimaler Abstand
const MAX_D   = 4.0;  // Maximaler Abstand
let DIST      = 1.2;  // Startabstand (sichtbar nah)

// === Elemente ===
const scene   = document.querySelector('a-scene');
const startBtn= document.getElementById('start');
const nearBtn = document.getElementById('near');
const farBtn  = document.getElementById('far');
const centerBtn=document.getElementById('center');
const clearBtn= document.getElementById('clear');

let xrSession = null;
let placedEl  = null;

startBtn.addEventListener('click', async () => {
  try{
    await ensureARSession();
    ensurePlacedVisible();
    placeInFrontOfCamera();
  }catch(e){
    alert('AR nicht verfügbar: '+e.message+'\nTipp: Chrome auf Android benutzen.');
  }
});

nearBtn.addEventListener('click', ()=>{ DIST = Math.max(MIN_D, DIST-0.2); placeInFrontOfCamera(); });
farBtn .addEventListener('click', ()=>{ DIST = Math.min(MAX_D, DIST+0.2); placeInFrontOfCamera(); });
centerBtn.addEventListener('click', ()=>{ placeInFrontOfCamera(true); });
clearBtn.addEventListener('click', ()=>{ if(placedEl){ placedEl.remove(); placedEl=null; }});

async function ensureARSession(){
  if (!navigator.xr) throw new Error('WebXR nicht vorhanden');
  const supported = await navigator.xr.isSessionSupported('immersive-ar');
  if (!supported) throw new Error('immersive-ar wird nicht unterstützt');
  const session = await navigator.xr.requestSession('immersive-ar', {
    requiredFeatures: ['local'],
    optionalFeatures: ['dom-overlay'],
    domOverlay: { root: document.body }
  });
  scene.renderer.xr.setSession(session);
  const gl = scene.renderer.getContext();
  if (gl.makeXRCompatible) await gl.makeXRCompatible();
  xrSession = session;
  xrSession.addEventListener('end', ()=>{ xrSession=null; });
}

function ensurePlacedVisible(){
  if (placedEl) return;
  placedEl = document.createElement('a-entity');

  const plane = document.createElement('a-plane');
  plane.setAttribute('width', IMG_W + 0.06);
  plane.setAttribute('height', IMG_H + 0.06);
  plane.setAttribute('material', 'color: #00ffff; opacity: .14; side: double; shader: flat; transparent: true');

  const img = document.createElement('a-image');
  img.setAttribute('src', IMG_SRC);
  img.setAttribute('crossorigin','anonymous');
  img.setAttribute('width', IMG_W);
  img.setAttribute('height', IMG_H);

  placedEl.appendChild(plane);
  placedEl.appendChild(img);
  scene.appendChild(placedEl);
}

function placeInFrontOfCamera(resetRotation=false){
  const cam = document.getElementById('camera').object3D;
  const worldPos = new THREE.Vector3();
  const forward  = new THREE.Vector3();
  cam.getWorldPosition(worldPos);
  cam.getWorldDirection(forward);
  // WorldDirection zeigt von Kamera nach VORN (−Z in A‑Frame/three.js). Wir multiplizieren mit DIST
  const target = worldPos.clone().add(forward.multiplyScalar(DIST));

  if (!placedEl) return;
  placedEl.object3D.position.copy(target);

  // Bild vertikal „stehend“ ausrichten & zur Kamera drehen (einfaches Billboarding)
  const up = new THREE.Vector3(0,1,0);
  placedEl.object3D.lookAt(worldPos.x, target.y, worldPos.z); // nur horizontaler Blick
  if (resetRotation){
    placedEl.object3D.rotation.x = 0; // keine Neigung
  }
}

// Während der AR‑Session die Position mitführen, damit es „vor dir“ bleibt, wenn du direkt nach Start läufst
scene.addEventListener('renderstart', ()=>{
  scene.renderer.setAnimationLoop(()=>{
    if (xrSession && placedEl){ placeInFrontOfCamera(); }
  });
});
</script>

</body>
</html>
