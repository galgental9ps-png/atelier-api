<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WebAR – Bild 1,2 m vor der Kamera (ohne Geo)</title>

<!-- A-Frame + AR.js -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif}
  #overlay{position:fixed;inset:0;display:grid;place-items:center;background:#000c;z-index:10;text-align:center;padding:16px}
  .btn{padding:12px 16px;border:0;border-radius:12px;font-weight:800;color:#fff;background:#0ea5e9;cursor:pointer}
  #status{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);background:#000d;padding:8px 12px;border-radius:10px;z-index:5;font-weight:700}
</style>
</head>
<body>

<div id="overlay">
  <div>
    <h1 style="margin:0 0 10px">AR starten</h1>
    <p style="opacity:.9;max-width:560px;margin:0 auto 14px">
      Erlaube <b>Kamera</b> (auf iOS ggf. zusätzlich <b>Bewegung</b>).
      Das Bild erscheint <b>sofort</b> ca. 1,2 m vor der Kamera.
    </p>
    <button id="start" class="btn">Los geht’s</button>
  </div>
</div>

<div id="status">Bereit…</div>
<div id="mount"></div>

<script>
/* ===== Konfig ===== */
const IMG_PRIMARY  = "https://galgental9ps-png.github.io/atelier-api/echo_der_gedanken.jpg"; // dein Bild
const IMG_FALLBACK = "https://upload.wikimedia.org/wikipedia/commons/3/3f/Fronalpstock_big.jpg"; // immer verfügbar
const SIZE_M = { w: 1.6, h: 1.2 }; // Größe in Metern
const DIST_M = 1.2;                // Abstand vor der Kamera

/* ===== UI/State ===== */
const overlay = document.getElementById('overlay');
const statusEl = document.getElementById('status');
const mount = document.getElementById('mount');
let sceneEl, camEl, boardEl;

document.getElementById('start').addEventListener('click', startAR);

async function startAR(){
  try{
    await ensurePermissions();
    buildScene();
    await onSceneLoaded();
    await buildBoard();   // Bild direkt vor die Kamera
    overlay.style.display='none';
    status("AR aktiv – Bild sollte sichtbar sein.");
  }catch(e){
    status("Start-Fehler: " + (e?.message || e));
  }
}

/* ===== Permissions ===== */
async function ensurePermissions(){
  // Kamera
  await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
  // iOS Bewegung (best effort)
  try{
    if (typeof DeviceMotionEvent?.requestPermission === 'function') await DeviceMotionEvent.requestPermission().catch(()=>{});
    if (typeof DeviceOrientationEvent?.requestPermission === 'function') await DeviceOrientationEvent.requestPermission().catch(()=>{});
  }catch{}
}

/* ===== Scene ===== */
function buildScene(){
  if (sceneEl) return;
  mount.innerHTML = `
    <a-scene embedded vr-mode-ui="enabled:false"
      renderer="antialias:true; alpha:true"
      arjs="sourceType: webcam; videoTexture:true; facingMode: environment; trackingMethod: best; debugUIEnabled:false">

      <!-- Beide Bilder vorladen (mit Cachebuster) -->
      <a-assets timeout="15000" crossorigin="anonymous">
        <img id="imgPrimary"  src="${IMG_PRIMARY}?v=${Date.now()}"  crossorigin="anonymous">
        <img id="imgFallback" src="${IMG_FALLBACK}?v=${Date.now()}" crossorigin="anonymous">
      </a-assets>

      <a-entity id="rig">
        <a-camera id="cam" rotation-reader></a-camera>
      </a-entity>
    </a-scene>`;
  sceneEl = document.querySelector('a-scene');
  camEl   = document.getElementById('cam');
}
function onSceneLoaded(){
  return new Promise(res=>{
    if (sceneEl.hasLoaded) return res();
    sceneEl.addEventListener('loaded', res, { once:true });
  });
}

/* ===== Billboard (Bild vor Kamera) ===== */
async function buildBoard(){
  if (boardEl) return;

  const ok = await imageOk(document.getElementById('imgPrimary'));
  const srcId = ok ? '#imgPrimary' : '#imgFallback';
  status(ok ? "Dein Bild geladen." : "Dein Bild fehlgeschlagen – Fallback angezeigt.");

  boardEl = document.createElement('a-entity');
  boardEl.setAttribute('position', `0 0 ${-DIST_M}`); // vor der Kamera
  boardEl.setAttribute('visible', 'true');

  // Rahmen (leicht, damit man’s sieht)
  const frame = document.createElement('a-plane');
  frame.setAttribute('width',  SIZE_M.w + 0.08);
  frame.setAttribute('height', SIZE_M.h + 0.08);
  frame.setAttribute('position','0 0 -0.02');
  frame.setAttribute('material','shader: flat; color:#00ffff; opacity:.16; transparent:true; side:double');

  // Bild
  const img = document.createElement('a-image');
  img.setAttribute('src', srcId);
  img.setAttribute('width',  SIZE_M.w);
  img.setAttribute('height', SIZE_M.h);

  // Wenn Primary später doch lädt, automatisch auf Primary umschalten
  if (!ok){
    const prim = document.getElementById('imgPrimary');
    prim.addEventListener('load', ()=>{ img.setAttribute('src', '#imgPrimary'); status("Dein Bild nachgeladen – Fallback ersetzt."); }, { once:true });
  }

  boardEl.appendChild(frame);
  boardEl.appendChild(img);
  camEl.appendChild(boardEl);
}

function imageOk(imgEl){
  return new Promise(resolve=>{
    if (imgEl.complete && imgEl.naturalWidth>0) return resolve(true);
    const onLoad  = ()=>{ cleanup(); resolve(true); };
    const onError = ()=>{ cleanup(); resolve(false); };
    function cleanup(){ imgEl.removeEventListener('load', onLoad); imgEl.removeEventListener('error', onError); }
    imgEl.addEventListener('load', onLoad);
    imgEl.addEventListener('error', onError);
    setTimeout(()=>{ cleanup(); resolve(imgEl.complete && imgEl.naturalWidth>0); }, 6000);
  });
}

/* ===== Status ===== */
function status(msg){ statusEl.textContent = msg; console.log(msg); }
</script>
</body>
</html>
