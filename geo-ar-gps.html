<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Geo-AR mit HUD & Firebase (sicher)</title>

<!-- A-Frame + AR.js -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
<!-- Billboarding-Component -->
<script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif}
  #overlay{position:fixed;inset:0;display:grid;place-items:center;background:#000c;z-index:10;text-align:center;padding:16px}
  .btn{padding:12px 14px;border:0;border-radius:12px;font-weight:800;color:#fff;background:#0ea5e9;margin:0 6px;cursor:pointer}
  .btn.red{background:#ef4444}
  .btn.gray{background:#374151}
  #status{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);background:#000d;padding:10px 14px;border-radius:10px;z-index:5;white-space:nowrap;font-weight:700}
  #hud{position:fixed;top:84px;left:50%;transform:translateX(-50%);z-index:6;display:flex;flex-direction:column;align-items:center;gap:8px;pointer-events:none}
  #arrow{width:96px;height:96px;filter:drop-shadow(0 0 8px #00ffff);transition:transform 80ms linear}
  #dist{font-size:18px;font-weight:900;background:#000c;padding:8px 12px;border-radius:999px}
  #corner{position:fixed;top:12px;right:12px;z-index:7;display:flex;gap:8px;align-items:center}
  .chip{background:#000d;border:1px solid #1f2937;color:#fff;padding:8px 10px;border-radius:10px;font-size:12px}
  /* Login Dropdown */
  #authBox{background:#0b1220ee;border:1px solid #1f2937;border-radius:12px;padding:10px;display:none}
  #authBox input{width:220px;margin:6px 0;padding:8px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#fff}
</style>
</head>
<body>

<!-- Overlay -->
<div id="overlay">
  <div>
    <h1 style="margin:0 0 8px">Geo-AR starten</h1>
    <p style="opacity:.9;max-width:640px;margin:0 auto 14px">
      Erlaube <b>Kamera</b>, <b>Standort</b> und ggf. <b>Bewegungssensor</b> (iOS).<br>
      <b>Los gehtâ€™s</b> zeigt Spots + HUD (Richtung & Entfernung).<br>
      <b>Spot setzen</b> ist nur sichtbar, wenn du als Admin eingeloggt bist.
    </p>
    <button id="start" class="btn">Los gehtâ€™s</button>
    <button id="admin" class="btn red" style="display:none">Spot setzen (Admin)</button>
  </div>
</div>

<!-- Ecke oben rechts: nÃ¤chster Spot + Auth -->
<div id="corner">
  <div class="chip">ðŸŽ¯ NÃ¤chster Spot: <span id="nearestName">â€“</span></div>

  <div>
    <button id="authToggle" class="btn gray">Anmelden</button>
    <div id="authBox">
      <div id="authState" style="font-size:12px;opacity:.85;margin-bottom:6px;">Nicht angemeldet</div>
      <input id="email" type="email" placeholder="E-Mail">
      <input id="password" type="password" placeholder="Passwort">
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">
        <button id="doLogin" class="btn">Login</button>
        <button id="doLogout" class="btn gray">Logout</button>
        <button id="closeAuth" class="btn gray">SchlieÃŸen</button>
      </div>
    </div>
  </div>
</div>

<!-- HUD -->
<div id="hud">
  <svg id="arrow" viewBox="0 0 100 100" aria-label="Richtung zum Spot">
    <polygon points="50,5 80,55 60,55 60,95 40,95 40,55 20,55" fill="#00ffff" opacity="0.95"/>
  </svg>
  <div id="dist">Entfernung: â€“</div>
</div>

<div id="status">Bereitâ€¦</div>
<div id="mount"></div>

<!-- Firebase (ESM) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app-check.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  /* ====== KONFIG ====== */
  const ADMIN_UID = "iV1nvvmwxMcNEdQt72otPOckN3h2";                 // <â€” DEINE UID
  const RECAPTCHA_SITE_KEY = "RECAPTCHA_SITE_KEY_HIER";         // <â€” App Check Site-Key (optional)
  const firebaseConfig = {
    apiKey: "AIzaSyAd4_0zLdbI6jkjcZZUtMSWCYKP14dGHzQ",
    authDomain: "geo-ar-2c66d.firebaseapp.com",
    projectId: "geo-ar-2c66d",
    storageBucket: "geo-ar-2c66d.appspot.com",
    messagingSenderId: "232770478087",
    appId: "1:232770478087:web:d0d6cb8a585bdef5fdcaa2"
  };

  const app = initializeApp(firebaseConfig);

  // App Check (optional, aber empfohlen)
  if (RECAPTCHA_SITE_KEY && RECAPTCHA_SITE_KEY !== "RECAPTCHA_SITE_KEY_HIER") {
    initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),
      isTokenAutoRefreshEnabled: true
    });
  }

  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ==== UI-Refs ====
  const mount    = document.getElementById('mount');
  const overlay  = document.getElementById('overlay');
  const statusEl = document.getElementById('status');
  const arrowEl  = document.getElementById('arrow');
  const distEl   = document.getElementById('dist');
  const nearestNameEl = document.getElementById('nearestName');

  const authToggle = document.getElementById('authToggle');
  const authBox    = document.getElementById('authBox');
  const authState  = document.getElementById('authState');
  const doLogin    = document.getElementById('doLogin');
  const doLogout   = document.getElementById('doLogout');
  const closeAuth  = document.getElementById('closeAuth');

  const btnStart = document.getElementById('start');
  const btnAdmin = document.getElementById('admin');

  /* ====== Anzeige/Assets ====== */
  const IMG_SRC   = "https://galgental9ps-png.github.io/atelier-api/echo_der_gedanken.jpg";
  const BIG_SCALE = "34 25.5 1";
  const BILLBOARD_SIZE = { w: 1.2, h: 0.9 }; // m
  const BILLBOARD_OFFSET_Z = -1.2;           // m
  const SHOW_RADIUS_M = 80;

  /* Feste Spots */
  const BASE_TARGETS = [
    { name: 'Altstadt-Spot',         lat: 48.366184, lon: 10.867701 },
    { name: 'StettenstraÃŸe 7',       lat: 48.368905, lon: 10.898445 },
    { name: 'Neuer Spot',            lat: 48.36630,  lon: 10.86781  },
    { name: 'GabelsbergerstraÃŸe 64', lat: 48.33598,  lon: 10.86728  }
  ];
  let REMOTE_TARGETS = [];

  /* ====== State ====== */
  let sceneEl, started=false, deviceHeadingDeg=null, geoWatchId=null;
  let cameraEl, billboardEl=null, billboardVisible=false;

  /* ====== Auth UI ====== */
  authToggle.addEventListener('click', ()=> authBox.style.display = authBox.style.display==='block' ? 'none' : 'block');
  closeAuth.addEventListener('click', ()=> authBox.style.display='none');

  doLogin.addEventListener('click', async ()=>{
    const email = document.getElementById('email').value.trim();
    const pass  = document.getElementById('password').value;
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      statusEl.textContent = "Login erfolgreich.";
      authBox.style.display='none';
    }catch(e){
      statusEl.textContent = "Login fehlgeschlagen: " + e.message;
    }
  });

  doLogout.addEventListener('click', async ()=>{
    await signOut(auth);
    statusEl.textContent = "Abgemeldet.";
  });

  onAuthStateChanged(auth, user=>{
    const isAdmin = !!user && user.uid === ADMIN_UID;
    authState.textContent = user ? `Angemeldet: ${user.email} ${isAdmin ? "(Admin)" : ""}` : "Nicht angemeldet";
    btnAdmin.style.display = isAdmin ? 'inline-block' : 'none';
    authToggle.textContent = user ? "Konto" : "Anmelden";
  });

  /* ====== Buttons ====== */
  btnStart.addEventListener('click', startViewer);
  btnAdmin.addEventListener('click', startAdmin);

  /* ====== Start: Viewer ====== */
  async function startViewer(){
    try{
      await ensureCameraAndMotion();
      ensureScene();
      overlay.style.display='none';
      await ensureGeoWatch();

      ensureBillboard();

      BASE_TARGETS.forEach(t => appendSpotEntity(t));
      await loadRemoteSpots();
      REMOTE_TARGETS.forEach(t => appendSpotEntity(t));

      started=true;
      statusEl.textContent='Viewer aktiv. Bild wird vor der Kamera eingeblendet, wenn du nah am Spot bist.';
    }catch(e){
      statusEl.textContent='Start-Fehler: '+e.message;
    }
  }

  /* ====== Start: Admin (nur sichtbar, wenn Admin) ====== */
  async function startAdmin(){
    const user = auth.currentUser;
    if(!user || user.uid !== ADMIN_UID){
      alert("Keine Berechtigung. Bitte mit Admin-Account anmelden.");
      return;
    }
    try{
      await ensureCameraAndMotion();
      ensureScene();
      overlay.style.display='none';
      const pos = await getOnceLocation();
      const { latitude, longitude, accuracy } = pos.coords;

      await addDoc(collection(db,'spots'),{
        name:'Echo der Gedanken',
        img: IMG_SRC,
        lat: Number(latitude.toFixed(6)),
        lon: Number(longitude.toFixed(6)),
        createdAt: serverTimestamp()
      });

      statusEl.textContent = `Gespeichert: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (Â±${Math.round(accuracy)} m)`;
    }catch(e){
      console.error(e);
      statusEl.textContent = 'Admin-Fehler: '+e.message;
    }
  }

  /* ====== Szene (einmal) ====== */
  function ensureScene(){
    if(sceneEl) return;
    mount.innerHTML = `
      <a-scene embedded vr-mode-ui="enabled:false"
        renderer="antialias:true; alpha:true"
        arjs="sourceType: webcam; videoTexture:true; trackingMethod: best; facingMode: environment;">
        <a-entity id="rig">
          <a-camera id="cam" gps-camera="gpsMinDistance:0; gpsTimeInterval:1000" rotation-reader></a-camera>
        </a-entity>
      </a-scene>`;
    sceneEl = document.querySelector('a-scene');
    cameraEl = document.getElementById('cam');
    startHeadingListeners();
  }

  /* ====== Billboard (vor der Kamera) ====== */
  function ensureBillboard(){
    if (billboardEl) return;
    billboardEl = document.createElement('a-entity');
    billboardEl.setAttribute('position', `0 0 ${BILLBOARD_OFFSET_Z}`);
    billboardEl.setAttribute('visible', 'false');

    const frame = document.createElement('a-plane');
    frame.setAttribute('width', BILLBOARD_SIZE.w + 0.06);
    frame.setAttribute('height', BILLBOARD_SIZE.h + 0.06);
    frame.setAttribute('position','0 0 -0.02');
    frame.setAttribute('material','shader: flat; color:#00ffff; opacity:.12; transparent:true; side: double');

    const img = document.createElement('a-image');
    img.setAttribute('src', IMG_SRC);
    img.setAttribute('crossorigin','anonymous');
    img.setAttribute('width', BILLBOARD_SIZE.w);
    img.setAttribute('height', BILLBOARD_SIZE.h);

    billboardEl.appendChild(frame);
    billboardEl.appendChild(img);
    cameraEl.appendChild(billboardEl);
  }
  function setBillboardVisible(v){
    if (!billboardEl) return;
    if (billboardVisible === v) return;
    billboardVisible = v;
    billboardEl.setAttribute('visible', v ? 'true' : 'false');
  }

  /* ====== Geo-Entities (optional zusÃ¤tzlich) ====== */
  function appendSpotEntity(d){
    const el=document.createElement('a-entity');
    el.setAttribute('gps-entity-place',`latitude: ${d.lat}; longitude: ${d.lon};`);

    const plane = document.createElement('a-plane');
    plane.setAttribute('width','36');
    plane.setAttribute('height','27');
    plane.setAttribute('position','0 0 -0.02');
    plane.setAttribute('material','shader: flat; color: #00ffff; opacity: 0.12; transparent:true; side: double');
    plane.setAttribute('look-at','[gps-camera]');

    const img = document.createElement('a-image');
    img.setAttribute('src', d.img||IMG_SRC);
    img.setAttribute('crossorigin','anonymous');
    img.setAttribute('scale', BIG_SCALE);
    img.setAttribute('material','shader: flat; opacity:1; side: double');
    img.setAttribute('look-at','[gps-camera]');

    const ring = document.createElement('a-ring');
    ring.setAttribute('radius-inner','17');
    ring.setAttribute('radius-outer','17.8');
    ring.setAttribute('position','0 0 0.02');
    ring.setAttribute('material','color:#00ffff; shader:flat; opacity:0.95; transparent:true; side: double');
    ring.setAttribute('animation__pulse','property=scale; to=1.06 1.06 1; dir=alternate; dur=700; loop:true; easing=easeInOutSine');

    el.appendChild(plane);
    el.appendChild(img);
    el.appendChild(ring);

    sceneEl.appendChild(el);
  }

  /* ====== Firestore laden ====== */
  async function loadRemoteSpots(){
    try{
      const snap = await getDocs(collection(db,'spots'));
      REMOTE_TARGETS = snap.docs.map(d=>{
        const x=d.data(); return { name:x.name||'Spot', img:x.img||IMG_SRC, lat:x.lat, lon:x.lon };
      });
    }catch(e){
      console.warn('Spots laden fehlschlag:', e);
    }
  }

  /* ====== Kamera + Sensoren ====== */
  async function ensureCameraAndMotion(){
    await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
    try{
      if(typeof DeviceMotionEvent?.requestPermission === 'function'){ await DeviceMotionEvent.requestPermission().catch(()=>{}); }
      if(typeof DeviceOrientationEvent?.requestPermission === 'function'){ await DeviceOrientationEvent.requestPermission().catch(()=>{}); }
    }catch(e){}
  }

  /* ====== GPS ====== */
  function getOnceLocation(){
    return new Promise((res,rej)=>{
      if(!('geolocation' in navigator)) return rej(new Error('Geolocation nicht unterstÃ¼tzt'));
      navigator.geolocation.getCurrentPosition(res, e=>rej(new Error(e.message)),
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
    });
  }
  function ensureGeoWatch(){
    return new Promise((resolve,reject)=>{
      if(!('geolocation' in navigator)) return reject(new Error('Geolocation nicht unterstÃ¼tzt'));
      navigator.geolocation.getCurrentPosition(p=>{
        if(geoWatchId!=null) navigator.geolocation.clearWatch(geoWatchId);
        geoWatchId = navigator.geolocation.watchPosition(
          pos=>{ updateHudAndBillboard(pos.coords); },
          err=>{ statusEl.textContent='GPS-Fehler: '+err.message; },
          { enableHighAccuracy:true, timeout:20000, maximumAge:0 }
        );
        updateHudAndBillboard(p.coords);
        resolve();
      },err=>reject(err),{ enableHighAccuracy:true, timeout:15000, maximumAge:0 });
    });
  }

  /* ====== HUD + Billboard-Logik ====== */
  function updateHudAndBillboard(coords){
    const all=[...BASE_TARGETS, ...REMOTE_TARGETS];
    if(!all.length) return;

    const { latitude, longitude, accuracy } = coords;
    const ranked = all
      .map(t=>({ t, d: distM(latitude, longitude, t.lat, t.lon), brg: bearing(latitude, longitude, t.lat, t.lon) }))
      .sort((a,b)=>a.d-b.d);
    const nearest = ranked[0];

    nearestNameEl.textContent = nearest.t.name || 'Spot';
    const txt = nearest.d>=1000 ? (nearest.d/1000).toFixed(2)+' km' : Math.round(nearest.d)+' m';
    distEl.textContent = `Entfernung: ${txt} Â· GPS Â±${Math.round(accuracy)} m`;

    if (deviceHeadingDeg!=null){
      const turn=((nearest.brg - deviceHeadingDeg)+360)%360;
      arrowEl.style.transform=`rotate(${turn}deg)`;
    }
    statusEl.textContent = `Kurs: ${nearest.brg.toFixed(0)}Â° Â· Heading: ${deviceHeadingDeg!=null?deviceHeadingDeg.toFixed(0)+'Â°':'â€“'}`;

    setBillboardVisible(nearest.d <= SHOW_RADIUS_M);
  }

  /* ====== Kompass ====== */
  function startHeadingListeners(){
    window.addEventListener('deviceorientation', e=>{
      if (typeof e.webkitCompassHeading === 'number'){
        deviceHeadingDeg = e.webkitCompassHeading; // iOS
      }else if (e.absolute===true && typeof e.alpha === 'number'){
        deviceHeadingDeg = 360 - e.alpha; // Android (ungefÃ¤hr)
      }
    }, true);
    window.addEventListener('deviceorientationabsolute', e=>{
      if (typeof e.alpha === 'number'){ deviceHeadingDeg = 360 - e.alpha; }
    }, true);
  }

  /* ====== Geo-Utils ====== */
  const toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
  function distM(la1,lo1,la2,lo2){
    const R=6371e3, dLa=toRad(la2-la1), dLo=toRad(lo2-lo1);
    const a=Math.sin(dLa/2)**2+Math.cos(toRad(la1))*Math.cos(toRad(la2))*Math.sin(dLo/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }
  function bearing(la1,lo1,la2,lo2){
    const Ï†1=toRad(la1), Ï†2=toRad(la2), Î»1=toRad(lo1), Î»2=toRad(lo2);
    const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2);
    const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*cos(Î»2-Î»1);
    return (toDeg(Math.atan2(y,x))+360)%360;
  }
  function cos(v){ return Math.cos(v); }

</script>
</body>
</html>
