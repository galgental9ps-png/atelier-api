<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>AR Bild an die Wand (ohne Spots)</title>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif}
  #ui{position:fixed;inset:0;pointer-events:none;display:flex;flex-direction:column;justify-content:space-between}
  #top{display:flex;gap:8px;align-items:center;justify-content:center;margin:12px}
  .chip{pointer-events:auto;background:#000c;border:1px solid #334155;padding:8px 10px;border-radius:999px;font-size:13px}
  #panel{pointer-events:auto;display:flex;gap:8px;align-items:center;justify-content:center;margin:0 12px 16px}
  #url{flex:1;min-width:120px;max-width:640px;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  #start{padding:10px 14px;border:0;border-radius:12px;font-weight:800;color:#fff;background:#0ea5e9;white-space:nowrap}
  #status{pointer-events:auto;align-self:center;margin-bottom:12px;background:#000c;border:1px solid #334155;
          padding:8px 12px;border-radius:10px;font-weight:700}
  #note{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#111d;border:1px solid #334155;
        padding:12px 14px;border-radius:12px;display:none}
  canvas{display:block}
</style>
</head>
<body>
<div id="ui">
  <div id="top">
    <div class="chip">ðŸŽ¯ Tipp auf FlÃ¤che, um zu platzieren</div>
    <div class="chip">ðŸ§­ Hit-Test aktiv â€¢ Fallback: 3 m</div>
  </div>
  <div id="note">Bild wird geladenâ€¦</div>
  <div id="panel">
    <input id="url" type="url" placeholder="Bild-URL (https://â€¦)" />
    <button id="start">AR starten</button>
  </div>
  <div id="status">Bereitâ€¦</div>
</div>

<script type="module">
// --------- Three.js + WebXR ----------
import * as THREE from "https://unpkg.com/three@0.158.0/build/three.module.js";
import { ARButton } from "https://unpkg.com/three@0.158.0/examples/jsm/webxr/ARButton.js";

// --------- UI refs ----------
const urlInput = document.getElementById('url');
const startBtn = document.getElementById('start');
const statusEl = document.getElementById('status');
const noteEl   = document.getElementById('note');

// Komfort: Default-Repo-Basis & ?img= unterstÃ¼tzen
const GHPAGES_BASE = "https://galgental9ps-png.github.io/atelier-api/";
const qp = new URLSearchParams(location.search);
const qpImg = qp.get("img");
if (qpImg) {
  // voller Link oder nur Dateiname
  urlInput.value = qpImg.startsWith("http") ? qpImg : (GHPAGES_BASE + qpImg);
} else {
  urlInput.value = GHPAGES_BASE + "echo_der_gedanken.jpg";
}

// --------- Three / AR globals ----------
let renderer, scene, camera;
let planeMesh=null, imgTexture=null;
let xrRefSpace, xrHitTestSource=null, reticle;
let placed=false;

// GrÃ¶ÃŸe: Standardbreite 1.2 m, HÃ¶he automatisch aus BildverhÃ¤ltnis
const DEFAULT_WIDTH_M = 1.2;

// --------- Setup 3D ----------
function setupThree(){
  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.01, 20);
  scene.add(camera);

  const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
  scene.add(hemi);

  // Reticle (zeigt Hit-Test-Position)
  reticle = new THREE.Mesh(
    new THREE.RingGeometry(0.08, 0.1, 32).rotateX(-Math.PI/2),
    new THREE.MeshBasicMaterial({ color: 0x00ffff })
  );
  reticle.matrixAutoUpdate = false;
  reticle.visible = false;
  scene.add(reticle);

  // Tap zum endgÃ¼ltigen Platzieren (nur 1x)
  renderer.domElement.addEventListener('click', ()=>{
    if(!renderer.xr.isPresenting || placed) return;
    if(planeMesh){
      if(reticle.visible){
        planeMesh.position.setFromMatrixPosition(reticle.matrix);
        planeMesh.quaternion.setFromRotationMatrix(reticle.matrix);
      }
      planeMesh.visible = true;
      placed = true;
      reticle.visible = false;
      statusEl.textContent = 'Platziert. (Beim Neuladen ist nichts gespeichert)';
    }
  });

  // Eigenen Button nutzen (default ARButton verstecken)
  const hiddenBtn = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'], optionalFeatures: ['dom-overlay'], domOverlay:{ root: document.body }});
  hiddenBtn.style.display = 'none';

  addEventListener('resize', ()=>{
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });
}

// --------- Bild-Texture laden ----------
function loadTexture(url){
  return new Promise((resolve,reject)=>{
    const loader = new THREE.TextureLoader();
    loader.setCrossOrigin('anonymous');
    loader.load(url, tex=>resolve(tex), undefined, err=>reject(err));
  });
}

// --------- Bild-Plane erzeugen ----------
function buildPlaneForTexture(tex){
  // SeitenverhÃ¤ltnis aus Texture ermitteln
  const img = tex.image;
  const aspect = (img && img.width && img.height) ? (img.height / img.width) : (2/3); // fallback Portrait
  const w = DEFAULT_WIDTH_M;
  const h = w * aspect;
  const geom = new THREE.PlaneGeometry(w, h);
  const mat  = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide });
  const mesh = new THREE.Mesh(geom, mat);
  mesh.visible = false; // erst nach Tap zeigen
  scene.add(mesh);
  return mesh;
}

// --------- AR-Start fÃ¼r ein Bild ----------
async function startARWithImage(imgURL){
  statusEl.textContent = 'Starte ARâ€¦';
  placed = false;

  // Bild laden (sichtbarer Loader)
  noteEl.style.display = 'block';
  try{
    imgTexture = await loadTexture(imgURL);
  }catch(e){
    noteEl.style.display = 'none';
    statusEl.textContent = 'Bild konnte nicht geladen werden.';
    return;
  }
  noteEl.style.display = 'none';

  if(planeMesh){ scene.remove(planeMesh); planeMesh.geometry.dispose(); planeMesh.material.dispose(); }
  planeMesh = buildPlaneForTexture(imgTexture);

  // Session anfordern
  try{
    const session = await navigator.xr.requestSession('immersive-ar', { requiredFeatures:['hit-test'], optionalFeatures:['dom-overlay'], domOverlay:{ root: document.body } });
    renderer.xr.setSession(session);

    session.addEventListener('end', ()=>{
      xrHitTestSource=null; xrRefSpace=null; placed=false; reticle.visible=false;
      statusEl.textContent = 'AR beendet.';
    });

    // Hit-Test Quelle
    const viewerSpace = await session.requestReferenceSpace('viewer');
    xrHitTestSource = await session.requestHitTestSource({ space: viewerSpace });
    xrRefSpace = await session.requestReferenceSpace('local');

    // Fallback: wenn nach 2s kein Hit-Test sichtbar â†’ Bild 3 m vor Kamera groÃŸ zeigen
    setTimeout(()=>{
      if(!renderer.xr.isPresenting || placed || !planeMesh) return;
      if(!reticle.visible && !planeMesh.visible){
        planeMesh.visible = true;
        planeMesh.position.set(0, 1.6, -3); // ~AugenhÃ¶he, 3 m
        statusEl.textContent = 'Hit-Test nicht verfÃ¼gbar â†’ Bild 3 m vor Kamera.';
      }
    }, 2000);

    renderer.setAnimationLoop(onXRFrame);

  }catch(err){
    // Komplett-Fallback (kein WebXR) â†’ 3 m vor Kamera
    planeMesh.visible = true;
    planeMesh.position.set(0, 1.6, -3);
    statusEl.textContent = 'AR nicht unterstÃ¼tzt â†’ Bild 3 m vor Kamera.';
  }
}

// --------- XR Frame Loop ----------
function onXRFrame(t, frame){
  if(!renderer.xr.isPresenting) return;
  const session = renderer.xr.getSession();
  if(!session) return;

  if(xrHitTestSource && xrRefSpace && !placed){
    const hits = frame.getHitTestResults(xrHitTestSource);
    if(hits.length){
      const pose = hits[0].getPose(xrRefSpace);
      reticle.visible = true;
      reticle.matrix.fromArray(pose.transform.matrix);
      statusEl.textContent = 'FlÃ¤che gefunden â€“ tippen zum Platzieren';
    }else{
      reticle.visible = false;
      statusEl.textContent = 'Suche FlÃ¤cheâ€¦ (zur Not 3 m vor Kamera)';
    }
  }
  renderer.render(scene, camera);
}

// --------- Boot ----------
(function boot(){
  setupThree();
  statusEl.textContent = 'Bild-URL prÃ¼fen und â€žAR startenâ€œ tippen.';
  startBtn.addEventListener('click', ()=>{
    const url = (urlInput.value || '').trim();
    if(!url || !/^https?:\/\//i.test(url)){
      statusEl.textContent = 'GÃ¼ltige Bild-URL eingeben (https://â€¦)';
      return;
    }
    startARWithImage(url);
  });
})();
</script>
</body>
</html>
